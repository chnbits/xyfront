import{S as ht}from"./spark-md5-89dc0feb.js";var et=globalThis&&globalThis.__extends||function(){var n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,i){o.__proto__=i}||function(o,i){for(var r in i)i.hasOwnProperty(r)&&(o[r]=i[r])},n(e,t)};return function(e,t){n(e,t);function o(){this.constructor=e}e.prototype=t===null?Object.create(t):(o.prototype=t.prototype,new o)}}(),d;(function(n){n.InvalidFile="InvalidFile",n.InvalidToken="InvalidToken",n.InvalidMetadata="InvalidMetadata",n.InvalidChunkSize="InvalidChunkSize",n.InvalidCustomVars="InvalidCustomVars",n.NotAvailableUploadHost="NotAvailableUploadHost",n.ReadCacheFailed="ReadCacheFailed",n.InvalidCacheData="InvalidCacheData",n.WriteCacheFailed="WriteCacheFailed",n.RemoveCacheFailed="RemoveCacheFailed",n.GetCanvasContextFailed="GetCanvasContextFailed",n.UnsupportedFileType="UnsupportedFileType",n.FileReaderReadFailed="FileReaderReadFailed",n.NotAvailableXMLHttpRequest="NotAvailableXMLHttpRequest",n.InvalidProgressEventTarget="InvalidProgressEventTarget",n.RequestError="RequestError"})(d||(d={}));var p=function(){function n(e,t){this.name=e,this.message=t,this.stack=new Error().stack}return n}(),S=function(n){et(e,n);function e(t,o,i,r){var s=n.call(this,d.RequestError,i)||this;return s.code=t,s.reqId=o,s.isRequestError=!0,s.data=r,s}return e}(p),ft=function(n){et(e,n);function e(t,o){return o===void 0&&(o=""),n.call(this,0,o,t)||this}return e}(S),dt=function(){function n(e,t){this.runTask=e,this.limit=t,this.queue=[],this.processing=[]}return n.prototype.enqueue=function(e){var t=this;return new Promise(function(o,i){t.queue.push({task:e,resolve:o,reject:i}),t.check()})},n.prototype.run=function(e){var t=this;this.queue=this.queue.filter(function(o){return o!==e}),this.processing.push(e),this.runTask(e.task).then(function(){t.processing=t.processing.filter(function(o){return o!==e}),e.resolve(),t.check()},function(o){return e.reject(o)})},n.prototype.check=function(){var e=this,t=this.processing.length,o=this.limit-t;this.queue.slice(0,o).forEach(function(i){e.run(i)})},n}(),pt=globalThis&&globalThis.__extends||function(){var n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,i){o.__proto__=i}||function(o,i){for(var r in i)i.hasOwnProperty(r)&&(o[r]=i[r])},n(e,t)};return function(e,t){n(e,t);function o(){this.constructor=e}e.prototype=t===null?Object.create(t):(o.prototype=t.prototype,new o)}}(),I=globalThis&&globalThis.__assign||function(){return I=Object.assign||function(n){for(var e,t=1,o=arguments.length;t<o;t++){e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i])}return n},I.apply(this,arguments)},gt=function(){function n(){this.closed=!1}return n.prototype.unsubscribe=function(){this.closed||(this.closed=!0,this._unsubscribe&&this._unsubscribe())},n.prototype.add=function(e){this._unsubscribe=e},n}(),vt=function(n){pt(e,n);function e(t,o,i){var r=n.call(this)||this;return r.isStopped=!1,t&&typeof t=="object"?r.destination=t:r.destination=I(I(I({},t&&{next:t}),o&&{error:o}),i&&{complete:i}),r}return e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,n.prototype.unsubscribe.call(this))},e.prototype.next=function(t){!this.isStopped&&this.destination.next&&this.destination.next(t)},e.prototype.error=function(t){!this.isStopped&&this.destination.error&&(this.isStopped=!0,this.destination.error(t))},e.prototype.complete=function(t){!this.isStopped&&this.destination.complete&&(this.isStopped=!0,this.destination.complete(t))},e}(gt),yt=function(){function n(e){this._subscribe=e}return n.prototype.subscribe=function(e,t,o){var i=new vt(e,t,o);return i.add(this._subscribe(i)),i},n}();function mt(n){if(n===null||typeof n=="undefined")return"";var e=n+"",t="",o,i,r=0;o=i=0,r=e.length;for(var s=0;s<r;s++){var u=e.charCodeAt(s),c=null;if(u<128)i++;else if(u>127&&u<2048)c=String.fromCharCode(u>>6|192,u&63|128);else if((u&63488^55296)>0)c=String.fromCharCode(u>>12|224,u>>6&63|128,u&63|128);else{if((u&64512^55296)>0)throw new RangeError("Unmatched trail surrogate at "+s);var a=e.charCodeAt(++s);if((a&64512^56320)>0)throw new RangeError("Unmatched lead surrogate at "+(s-1));u=((u&1023)<<10)+(a&1023)+65536,c=String.fromCharCode(u>>18|240,u>>12&63|128,u>>6&63|128,u&63|128)}c!==null&&(i>o&&(t+=e.slice(o,i)),t+=c,o=i=s+1)}return i>o&&(t+=e.slice(o,r)),t}function bt(n){var e=[],t=0,o=0,i=0;for(n+="";t<n.length;){o=n.charCodeAt(t)&255,i=0,o<=191?(o=o&127,i=1):o<=223?(o=o&31,i=2):o<=239?(o=o&15,i=3):(o=o&7,i=4);for(var r=1;r<i;++r)o=o<<6|n.charCodeAt(r+t)&63;i===4?(o-=65536,e.push(String.fromCharCode(55296|o>>10&1023)),e.push(String.fromCharCode(56320|o&1023))):e.push(String.fromCharCode(o)),t+=i}return e.join("")}function wt(n){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t,o,i,r,s,u,c,a,l=0,h=0,f="",g=[];if(!n)return n;n=mt(n+"");do t=n.charCodeAt(l++),o=n.charCodeAt(l++),i=n.charCodeAt(l++),a=t<<16|o<<8|i,r=a>>18&63,s=a>>12&63,u=a>>6&63,c=a&63,g[h++]=e.charAt(r)+e.charAt(s)+e.charAt(u)+e.charAt(c);while(l<n.length);switch(f=g.join(""),n.length%3){case 1:f=f.slice(0,-2)+"==";break;case 2:f=f.slice(0,-1)+"=";break}return f}function _t(n){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t,o,i,r,s,u,c,a,l=0,h=0,f="",g=[];if(!n)return n;n+="";do r=e.indexOf(n.charAt(l++)),s=e.indexOf(n.charAt(l++)),u=e.indexOf(n.charAt(l++)),c=e.indexOf(n.charAt(l++)),a=r<<18|s<<12|u<<6|c,t=a>>16&255,o=a>>8&255,i=a&255,u===64?g[h++]=String.fromCharCode(t):c===64?g[h++]=String.fromCharCode(t,o):g[h++]=String.fromCharCode(t,o,i);while(l<n.length);return f=g.join(""),bt(f)}function _(n){return n=wt(n),n.replace(/\//g,"_").replace(/\+/g,"-")}function xt(n){return n=n.replace(/_/g,"/").replace(/-/g,"+"),_t(n)}var q=globalThis&&globalThis.__assign||function(){return q=Object.assign||function(n){for(var e,t=1,o=arguments.length;t<o;t++){e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i])}return n},q.apply(this,arguments)},kt=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(r){return r instanceof t?r:new t(function(s){s(r)})}return new(t||(t=Promise))(function(r,s){function u(l){try{a(o.next(l))}catch(h){s(h)}}function c(l){try{a(o.throw(l))}catch(h){s(h)}}function a(l){l.done?r(l.value):i(l.value).then(u,c)}a((o=o.apply(n,e||[])).next())})},Tt=globalThis&&globalThis.__generator||function(n,e){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},o,i,r,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(l){return c([a,l])}}function c(a){if(o)throw new TypeError("Generator is already executing.");for(;t;)try{if(o=1,i&&(r=a[0]&2?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[a[0]&2,r.value]),a[0]){case 0:case 1:r=a;break;case 4:return t.label++,{value:a[1],done:!1};case 5:t.label++,i=a[1],a=[0];continue;case 7:a=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(a[0]===6||a[0]===2)){t=0;continue}if(a[0]===3&&(!r||a[1]>r[0]&&a[1]<r[3])){t.label=a[1];break}if(a[0]===6&&t.label<r[1]){t.label=r[1],r=a;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(a);break}r[2]&&t.ops.pop(),t.trys.pop();continue}a=e.call(n,t)}catch(l){a=[6,l],i=0}finally{o=r=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},x=Math.pow(1024,2);function Ct(n,e){var t=e*x;if(t>n.size)t=n.size;else for(;n.size>t*1e4;)t*=2;for(var o=[],i=Math.ceil(n.size/t),r=0;r<i;r++){var s=n.slice(t*r,r===i-1?n.size:t*(r+1));o.push(s)}return o}function It(n){return Object.keys(n).every(function(e){return e.indexOf("x-qn-meta-")===0})}function Ut(n){return Object.keys(n).every(function(e){return e.indexOf("x:")===0})}function St(n){return n.reduce(function(e,t){return e+t},0)}function Rt(n,e,t){try{localStorage.setItem(n,JSON.stringify(e))}catch{t.warn(new p(d.WriteCacheFailed,"setLocalFileInfo failed: "+n))}}function Ot(n,e,t){var o=e==null?"_":"_key_"+e+"_";return"qiniu_js_sdk_upload_file_name_"+n+o+"size_"+t}function j(n,e){try{localStorage.removeItem(n)}catch{e.warn(new p(d.RemoveCacheFailed,"removeLocalFileInfo failed. key: "+n))}}function zt(n,e){var t=null;try{t=localStorage.getItem(n)}catch{e.warn(new p(d.ReadCacheFailed,"getLocalFileInfo failed. key: "+n))}if(t==null)return null;var o=null;try{o=JSON.parse(t)}catch{j(n,e),e.warn(new p(d.InvalidCacheData,"getLocalFileInfo failed to parse. key: "+n))}return o}function R(n){var e="UpToken "+n;return{Authorization:e}}function Ft(n){var e=R(n);return q({"content-type":"application/octet-stream"},e)}function Et(n){var e=R(n);return q({"content-type":"application/json"},e)}function rt(){if(window.XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)return new window.ActiveXObject("Microsoft.XMLHTTP");throw new p(d.NotAvailableXMLHttpRequest,"the current environment does not support.")}function Pt(n){return kt(this,void 0,void 0,function(){var e,t;return Tt(this,function(o){switch(o.label){case 0:return[4,Lt(n)];case 1:return e=o.sent(),t=new ht.ArrayBuffer,t.append(e),[2,t.end()]}})})}function Lt(n){return new Promise(function(e,t){var o=new FileReader;o.onload=function(i){if(i.target){var r=i.target.result;e(r)}else t(new p(d.InvalidProgressEventTarget,"progress event target is undefined"))},o.onerror=function(){t(new p(d.FileReaderReadFailed,"fileReader read failed"))},o.readAsArrayBuffer(n)})}function m(n,e){return new Promise(function(t,o){var i=rt();if(i.open(e.method,n),e.onCreate&&e.onCreate(i),e.headers){var r=e.headers;Object.keys(r).forEach(function(s){i.setRequestHeader(s,r[s])})}i.upload.addEventListener("progress",function(s){s.lengthComputable&&e.onProgress&&e.onProgress({loaded:s.loaded,total:s.total})}),i.onreadystatechange=function(){var s=i.responseText;if(i.readyState===4){var u=i.getResponseHeader("x-reqId")||"";if(i.status===0){o(new ft("network error.",u));return}if(i.status!==200){var c="xhr request failed, code: "+i.status;s&&(c+=" response: "+s);var a=void 0;try{a=JSON.parse(s)}catch{}o(new S(i.status,u,c,a));return}try{t({data:JSON.parse(s),reqId:u})}catch(l){o(l)}}},i.send(e.body)})}function At(n){if(n&&n.match){var e=n.match(/(^https?)/);if(!e)return"";var t=e[1];return e=n.match(/^https?:\/\/([^:^/]*):(\d*)/),e?e[2]:t==="http"?"80":"443"}return""}function qt(n){if(n&&n.match){var e=n.match(/^https?:\/\/([^:^/]*)/);return e?e[1]:""}return""}function O(n){if(!n)throw new p(d.InvalidToken,"invalid token.");var e=n.split(":");if(e.length===1)throw new p(d.InvalidToken,"invalid token segments.");var t=e.length>3?e[1]:e[0];if(!t)throw new p(d.InvalidToken,"missing assess key field.");var o=null;try{o=JSON.parse(xt(e[e.length-1]))}catch{throw new p(d.InvalidToken,"token parse failed.")}if(o==null)throw new p(d.InvalidToken,"putPolicy is null.");if(o.scope==null)throw new p(d.InvalidToken,"scope field is null.");var i=o.scope.split(":")[0];if(!i)throw new p(d.InvalidToken,"resolve bucketName failed.");return{assessKey:t,bucketName:i,scope:o.scope}}function Ht(n){var e=window.URL||window.webkitURL||window.mozURL;return e.createObjectURL(n)}var y,w={z0:"z0",z1:"z1",z2:"z2",na0:"na0",as0:"as0",cnEast2:"cn-east-2"},Dt=(y={},y[w.z0]={srcUphost:["up.qiniup.com"],cdnUphost:["upload.qiniup.com"]},y[w.z1]={srcUphost:["up-z1.qiniup.com"],cdnUphost:["upload-z1.qiniup.com"]},y[w.z2]={srcUphost:["up-z2.qiniup.com"],cdnUphost:["upload-z2.qiniup.com"]},y[w.na0]={srcUphost:["up-na0.qiniup.com"],cdnUphost:["upload-na0.qiniup.com"]},y[w.as0]={srcUphost:["up-as0.qiniup.com"],cdnUphost:["upload-as0.qiniup.com"]},y[w.cnEast2]={srcUphost:["up-cn-east-2.qiniup.com"],cdnUphost:["upload-cn-east-2.qiniup.com"]},y),C=function(n){switch(typeof n){case"string":return n;case"boolean":return n?"true":"false";case"number":return isFinite(n)?n:"";default:return""}},Mt=function(n,e,t,o){return e=e||"&",t=t||"=",n===null&&(n=void 0),typeof n=="object"?Object.keys(n).map(function(i){var r=encodeURIComponent(C(i))+t;return Array.isArray(n[i])?n[i].map(function(s){return r+encodeURIComponent(C(s))}).join(e):r+encodeURIComponent(C(n[i]))}).filter(Boolean).join(e):o?encodeURIComponent(C(o))+t+encodeURIComponent(C(n)):""},nt;nt=Mt;var b=globalThis&&globalThis.__assign||function(){return b=Object.assign||function(n){for(var e,t=1,o=arguments.length;t<o;t++){e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i])}return n},b.apply(this,arguments)},it=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(r){return r instanceof t?r:new t(function(s){s(r)})}return new(t||(t=Promise))(function(r,s){function u(l){try{a(o.next(l))}catch(h){s(h)}}function c(l){try{a(o.throw(l))}catch(h){s(h)}}function a(l){l.done?r(l.value):i(l.value).then(u,c)}a((o=o.apply(n,e||[])).next())})},ot=globalThis&&globalThis.__generator||function(n,e){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},o,i,r,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(l){return c([a,l])}}function c(a){if(o)throw new TypeError("Generator is already executing.");for(;t;)try{if(o=1,i&&(r=a[0]&2?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[a[0]&2,r.value]),a[0]){case 0:case 1:r=a;break;case 4:return t.label++,{value:a[1],done:!1};case 5:t.label++,i=a[1],a=[0];continue;case 7:a=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(a[0]===6||a[0]===2)){t=0;continue}if(a[0]===3&&(!r||a[1]>r[0]&&a[1]<r[3])){t.label=a[1];break}if(a[0]===6&&t.label<r[1]){t.label=r[1],r=a;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(a);break}r[2]&&t.ops.pop(),t.trys.pop();continue}a=e.call(n,t)}catch(l){a=[6,l],i=0}finally{o=r=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};function at(n,e,t){return it(this,void 0,void 0,function(){var o,i;return ot(this,function(r){return o=nt({ak:n,bucket:e}),i=t+"://api.qiniu.com/v2/query?"+o,[2,m(i,{method:"GET"})]})})}function V(n,e,t){var o=t.url,i=t.id;return o+"/buckets/"+n+"/objects/"+(e!=null?_(e):"~")+"/uploads/"+i}function jt(n,e,t,o){var i=o+"/buckets/"+e+"/objects/"+(t!=null?_(t):"~")+"/uploads";return m(i,{method:"POST",headers:R(n)})}function $t(n,e,t,o,i){var r=O(n).bucketName,s=V(r,e,o)+("/"+t),u=Ft(n);return i.md5&&(u["Content-MD5"]=i.md5),m(s,b(b({},i),{method:"PUT",headers:u}))}function Bt(n,e,t,o){var i=O(n).bucketName,r=V(i,e,t);return m(r,b(b({},o),{method:"POST",headers:Et(n)}))}function Ce(n,e,t){var o=O(n).bucketName,i=V(o,e,t);return m(i,{method:"DELETE",headers:R(n)})}function Vt(n,e,t){return m(n,b({method:"POST",body:e},t))}function Ie(n,e){return it(this,void 0,void 0,function(){var t,o,i,r,s;return ot(this,function(u){switch(u.label){case 0:return t=ct(n),o=t.upprotocol,t.uphost.length>0?[2,o+"://"+t.uphost[0]]:(i=O(e),[4,at(i.assessKey,i.bucketName,o)]);case 1:return r=u.sent(),s=r.data.up.acc.main,[2,o+"://"+s[0]]}})})}var H=globalThis&&globalThis.__assign||function(){return H=Object.assign||function(n){for(var e,t=1,o=arguments.length;t<o;t++){e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i])}return n},H.apply(this,arguments)},N=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(r){return r instanceof t?r:new t(function(s){s(r)})}return new(t||(t=Promise))(function(r,s){function u(l){try{a(o.next(l))}catch(h){s(h)}}function c(l){try{a(o.throw(l))}catch(h){s(h)}}function a(l){l.done?r(l.value):i(l.value).then(u,c)}a((o=o.apply(n,e||[])).next())})},X=globalThis&&globalThis.__generator||function(n,e){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},o,i,r,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(l){return c([a,l])}}function c(a){if(o)throw new TypeError("Generator is already executing.");for(;t;)try{if(o=1,i&&(r=a[0]&2?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[a[0]&2,r.value]),a[0]){case 0:case 1:r=a;break;case 4:return t.label++,{value:a[1],done:!1};case 5:t.label++,i=a[1],a=[0];continue;case 7:a=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(a[0]===6||a[0]===2)){t=0;continue}if(a[0]===3&&(!r||a[1]>r[0]&&a[1]<r[3])){t.label=a[1];break}if(a[0]===6&&t.label<r[1]){t.label=r[1],r=a;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(a);break}r[2]&&t.ops.pop(),t.trys.pop();continue}a=e.call(n,t)}catch(l){a=[6,l],i=0}finally{o=r=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},Gt=globalThis&&globalThis.__read||function(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var o=t.call(n),i,r=[],s;try{for(;(e===void 0||e-- >0)&&!(i=o.next()).done;)r.push(i.value)}catch(u){s={error:u}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(s)throw s.error}}return r},Nt=globalThis&&globalThis.__spread||function(){for(var n=[],e=0;e<arguments.length;e++)n=n.concat(Gt(arguments[e]));return n},Xt=4,st=[0,502,503,504,599],Wt=Nt(st,[612]),Jt=Math.pow(1024,3),ut=function(){function n(e,t,o,i){this.hostPool=o,this.logger=i,this.aborted=!1,this.retryCount=0,this.xhrList=[],this.config=e.config,i.info("config inited.",this.config),this.putExtra=H({fname:""},e.putExtra),i.info("putExtra inited.",this.putExtra),this.key=e.key,this.file=e.file,this.token=e.token,this.onData=t.onData,this.onError=t.onError,this.onComplete=t.onComplete;try{var r=O(this.token);this.bucketName=r.bucketName,this.assessKey=r.assessKey}catch(s){i.error("get putPolicy from token failed.",s),this.onError(s)}}return n.prototype.checkAndUpdateUploadHost=function(){return N(this,void 0,void 0,function(){var e;return X(this,function(t){switch(t.label){case 0:return this.logger.info("get available upload host."),[4,this.hostPool.getUp(this.assessKey,this.bucketName,this.config.upprotocol)];case 1:if(e=t.sent(),e==null)throw new p(d.NotAvailableUploadHost,"no available upload host.");return this.uploadHost!=null&&this.uploadHost.host!==e.host?this.logger.warn("host switches from "+this.uploadHost.host+" to "+e.host+"."):this.logger.info("use host "+e.host+"."),this.uploadHost=e,[2]}})})},n.prototype.checkAndUnfreezeHost=function(){this.logger.info("check unfreeze host."),this.uploadHost!=null&&this.uploadHost.isFrozen()&&(this.logger.warn(this.uploadHost.host+" will be unfrozen."),this.uploadHost.unfreeze())},n.prototype.checkAndFreezeHost=function(e){this.logger.info("check freeze host."),e instanceof S&&this.uploadHost!=null&&st.includes(e.code)&&(this.logger.warn(this.uploadHost.host+" will be temporarily frozen."),this.uploadHost.freeze())},n.prototype.handleError=function(e){this.logger.error(e.message),this.onError(e)},n.prototype.putFile=function(){return N(this,void 0,void 0,function(){var e,t,o,i,r,s;return X(this,function(u){switch(u.label){case 0:if(this.aborted=!1,this.putExtra.fname||(this.logger.info("use file.name as fname."),this.putExtra.fname=this.file.name),this.file.size>1e4*Jt)return this.handleError(new p(d.InvalidFile,"file size exceed maximum value 10000G")),[2];if(this.putExtra.customVars&&!Ut(this.putExtra.customVars))return this.handleError(new p(d.InvalidCustomVars,"customVars key should start width x:")),[2];if(this.putExtra.metadata&&!It(this.putExtra.metadata))return this.handleError(new p(d.InvalidMetadata,"metadata key should start with x-qn-meta-")),[2];u.label=1;case 1:return u.trys.push([1,4,,5]),this.uploadAt=new Date().getTime(),[4,this.checkAndUpdateUploadHost()];case 2:return u.sent(),[4,this.run()];case 3:return e=u.sent(),this.onComplete(e.data),this.checkAndUnfreezeHost(),this.sendLog(e.reqId,200),[2];case 4:return t=u.sent(),this.logger.error(t),this.clear(),t instanceof S&&(o=this.aborted?"":t.reqId,i=this.aborted?-2:t.code,this.sendLog(o,i),this.checkAndFreezeHost(t),r=++this.retryCount<=this.config.retryCount,s=!this.aborted&&Wt.includes(t.code),s&&r)?(this.logger.warn("error auto retry: "+this.retryCount+"/"+this.config.retryCount+"."),this.putFile(),[2]):(this.onError(t),[3,5]);case 5:return[2]}})})},n.prototype.clear=function(){this.logger.info("start cleaning all xhr."),this.xhrList.forEach(function(e){e.onreadystatechange=null,e.abort()}),this.logger.info("cleanup completed."),this.xhrList=[]},n.prototype.stop=function(){this.logger.info("stop."),this.clear(),this.aborted=!0},n.prototype.addXhr=function(e){this.xhrList.push(e)},n.prototype.sendLog=function(e,t){var o,i;this.logger.report({code:t,reqId:e,remoteIp:"",upType:"jssdk-h5",size:this.file.size,time:Math.floor(this.uploadAt/1e3),port:At((o=this.uploadHost)===null||o===void 0?void 0:o.getUrl()),host:qt((i=this.uploadHost)===null||i===void 0?void 0:i.getUrl()),bytesSent:this.progress?this.progress.total.loaded:0,duration:Math.floor((new Date().getTime()-this.uploadAt)/1e3)})},n.prototype.getProgressInfoItem=function(e,t,o){return H({size:t,loaded:e,percent:e/t*100},o==null?{}:{fromCache:o})},n}(),Kt=globalThis&&globalThis.__extends||function(){var n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,i){o.__proto__=i}||function(o,i){for(var r in i)i.hasOwnProperty(r)&&(o[r]=i[r])},n(e,t)};return function(e,t){n(e,t);function o(){this.constructor=e}e.prototype=t===null?Object.create(t):(o.prototype=t.prototype,new o)}}(),U=globalThis&&globalThis.__assign||function(){return U=Object.assign||function(n){for(var e,t=1,o=arguments.length;t<o;t++){e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i])}return n},U.apply(this,arguments)},P=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(r){return r instanceof t?r:new t(function(s){s(r)})}return new(t||(t=Promise))(function(r,s){function u(l){try{a(o.next(l))}catch(h){s(h)}}function c(l){try{a(o.throw(l))}catch(h){s(h)}}function a(l){l.done?r(l.value):i(l.value).then(u,c)}a((o=o.apply(n,e||[])).next())})},L=globalThis&&globalThis.__generator||function(n,e){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},o,i,r,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(l){return c([a,l])}}function c(a){if(o)throw new TypeError("Generator is already executing.");for(;t;)try{if(o=1,i&&(r=a[0]&2?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[a[0]&2,r.value]),a[0]){case 0:case 1:r=a;break;case 4:return t.label++,{value:a[1],done:!1};case 5:t.label++,i=a[1],a=[0];continue;case 7:a=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(a[0]===6||a[0]===2)){t=0;continue}if(a[0]===3&&(!r||a[1]>r[0]&&a[1]<r[3])){t.label=a[1];break}if(a[0]===6&&t.label<r[1]){t.label=r[1],r=a;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(a);break}r[2]&&t.ops.pop(),t.trys.pop();continue}a=e.call(n,t)}catch(l){a=[6,l],i=0}finally{o=r=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};function Zt(n){var e=/^[1-9]\d*$/;return e.test(String(n))}var Yt=function(n){Kt(e,n);function e(){return n!==null&&n.apply(this,arguments)||this}return e.prototype.run=function(){return P(this,void 0,void 0,function(){var t,o,i,r,s,u=this;return L(this,function(c){switch(c.label){case 0:if(this.logger.info("start run Resume."),!this.config.chunkSize||!Zt(this.config.chunkSize))throw new p(d.InvalidChunkSize,"chunkSize must be a positive integer");if(this.config.chunkSize>1024)throw new p(d.InvalidChunkSize,"chunkSize maximum value is 1024");return[4,this.initBeforeUploadChunks()];case 1:c.sent(),t=new dt(function(a){return u.uploadChunk(a)},this.config.concurrentRequestLimit),o=null,i=this.getLocalKey(),r=this.chunks.map(function(a,l){return t.enqueue({chunk:a,index:l})}),c.label=2;case 2:return c.trys.push([2,5,,6]),[4,Promise.all(r)];case 3:return c.sent(),[4,this.mkFileReq()];case 4:return o=c.sent(),[3,6];case 5:throw s=c.sent(),s instanceof S&&(s.code===612||s.code===400)&&j(i,this.logger),s;case 6:return j(i,this.logger),[2,o]}})})},e.prototype.uploadChunk=function(t){return P(this,void 0,void 0,function(){var o,i,r,s,u,c,a,l,h,f=this;return L(this,function(g){switch(g.label){case 0:return o=t.index,i=t.chunk,r=this.cachedUploadedList[o],this.logger.info("upload part "+o+", cache:",r),s=this.config.checkByMD5,u=function(){f.usedCacheList[o]=!0,f.updateChunkProgress(i.size,o),f.uploadedList[o]=r,f.updateLocalCache()},r&&!s?(u(),[2]):[4,Pt(i)];case 1:return c=g.sent(),this.logger.info("computed part md5.",c),r&&c===r.md5?(u(),[2]):(this.usedCacheList[o]=!1,a=function(v){f.updateChunkProgress(v.loaded,o)},l={body:i,md5:this.config.checkByServer?c:void 0,onProgress:a,onCreate:function(v){return f.addXhr(v)}},this.logger.info("part "+o+" start uploading."),[4,$t(this.token,this.key,t.index+1,this.getUploadInfo(),l)]);case 2:return h=g.sent(),this.logger.info("part "+o+" upload completed."),a({loaded:i.size,total:i.size}),this.uploadedList[o]={etag:h.data.etag,md5:h.data.md5,size:i.size},this.updateLocalCache(),[2]}})})},e.prototype.mkFileReq=function(){return P(this,void 0,void 0,function(){var t,o,i=this;return L(this,function(r){switch(r.label){case 0:return t=U(U(U({parts:this.uploadedList.map(function(s,u){return{etag:s.etag,partNumber:u+1}}),fname:this.putExtra.fname},this.putExtra.mimeType&&{mimeType:this.putExtra.mimeType}),this.putExtra.customVars&&{customVars:this.putExtra.customVars}),this.putExtra.metadata&&{metadata:this.putExtra.metadata}),this.logger.info("parts upload completed, make file.",t),[4,Bt(this.token,this.key,this.getUploadInfo(),{onCreate:function(s){return i.addXhr(s)},body:JSON.stringify(t)})];case 1:return o=r.sent(),this.logger.info("finish Resume Progress."),this.updateMkFileProgress(1),[2,o]}})})},e.prototype.initBeforeUploadChunks=function(){return P(this,void 0,void 0,function(){var t,o,i;return L(this,function(r){switch(r.label){case 0:return this.uploadedList=[],this.usedCacheList=[],t=zt(this.getLocalKey(),this.logger),t?[3,2]:(this.logger.info("init upload parts from api."),[4,jt(this.token,this.bucketName,this.key,this.uploadHost.getUrl())]);case 1:return o=r.sent(),this.logger.info("initd upload parts of id: "+o.data.uploadId+"."),this.uploadId=o.data.uploadId,this.cachedUploadedList=[],[3,3];case 2:i=["resume upload parts from local cache,","total "+t.data.length+" part,","id is "+t.id+"."],this.logger.info(i.join(" ")),this.cachedUploadedList=t.data,this.uploadId=t.id,r.label=3;case 3:return this.chunks=Ct(this.file,this.config.chunkSize),this.loaded={mkFileProgress:0,chunks:this.chunks.map(function(s){return 0})},this.notifyResumeProgress(),[2]}})})},e.prototype.getUploadInfo=function(){return{id:this.uploadId,url:this.uploadHost.getUrl()}},e.prototype.getLocalKey=function(){return Ot(this.file.name,this.key,this.file.size)},e.prototype.updateLocalCache=function(){Rt(this.getLocalKey(),{id:this.uploadId,data:this.uploadedList},this.logger)},e.prototype.updateChunkProgress=function(t,o){this.loaded.chunks[o]=t,this.notifyResumeProgress()},e.prototype.updateMkFileProgress=function(t){this.loaded.mkFileProgress=t,this.notifyResumeProgress()},e.prototype.notifyResumeProgress=function(){var t=this;this.progress={total:this.getProgressInfoItem(St(this.loaded.chunks)+this.loaded.mkFileProgress,this.file.size+1),chunks:this.chunks.map(function(o,i){var r=t.usedCacheList[i];return t.getProgressInfoItem(t.loaded.chunks[i],o.size,r)}),uploadInfo:{id:this.uploadId,url:this.uploadHost.getUrl()}},this.onData(this.progress)},e}(ut),W=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(r){return r instanceof t?r:new t(function(s){s(r)})}return new(t||(t=Promise))(function(r,s){function u(l){try{a(o.next(l))}catch(h){s(h)}}function c(l){try{a(o.throw(l))}catch(h){s(h)}}function a(l){l.done?r(l.value):i(l.value).then(u,c)}a((o=o.apply(n,e||[])).next())})},J=globalThis&&globalThis.__generator||function(n,e){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},o,i,r,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(l){return c([a,l])}}function c(a){if(o)throw new TypeError("Generator is already executing.");for(;t;)try{if(o=1,i&&(r=a[0]&2?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[a[0]&2,r.value]),a[0]){case 0:case 1:r=a;break;case 4:return t.label++,{value:a[1],done:!1};case 5:t.label++,i=a[1],a=[0];continue;case 7:a=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(a[0]===6||a[0]===2)){t=0;continue}if(a[0]===3&&(!r||a[1]>r[0]&&a[1]<r[3])){t.label=a[1];break}if(a[0]===6&&t.label<r[1]){t.label=r[1],r=a;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(a);break}r[2]&&t.ops.pop(),t.trys.pop();continue}a=e.call(n,t)}catch(l){a=[6,l],i=0}finally{o=r=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},Qt=function(){function n(){this.crc=-1,this.table=this.makeTable()}return n.prototype.makeTable=function(){for(var e=new Array,t=0;t<256;t++){for(var o=t,i=0;i<8;i++)o&1?o=o>>>1^3988292384:o>>>=1;e[t]=o}return e},n.prototype.append=function(e){for(var t=this.crc,o=0;o<e.byteLength;o++)t=t>>>8^this.table[(t^e[o])&255];this.crc=t},n.prototype.compute=function(){return(this.crc^-1)>>>0},n.prototype.readAsUint8Array=function(e){return W(this,void 0,void 0,function(){var t;return J(this,function(o){switch(o.label){case 0:return typeof e.arrayBuffer!="function"?[3,2]:(t=Uint8Array.bind,[4,e.arrayBuffer()]);case 1:return[2,new(t.apply(Uint8Array,[void 0,o.sent()]))];case 2:return[2,new Promise(function(i,r){var s=new FileReader;s.onload=function(){if(s.result==null){r();return}if(typeof s.result=="string"){r();return}i(new Uint8Array(s.result))},s.readAsArrayBuffer(e)})]}})})},n.prototype.file=function(e){return W(this,void 0,void 0,function(){var t,o,i,r,s,u;return J(this,function(c){switch(c.label){case 0:return e.size<=x?(t=this.append,[4,this.readAsUint8Array(e)]):[3,2];case 1:return t.apply(this,[c.sent()]),[2,this.compute()];case 2:o=Math.ceil(e.size/x),i=0,c.label=3;case 3:return i<o?(r=i*x,s=i===o-1?e.size:r+x,[4,this.readAsUint8Array(e.slice(r,s))]):[3,6];case 4:u=c.sent(),this.append(new Uint8Array(u)),c.label=5;case 5:return i++,[3,3];case 6:return[2,this.compute()]}})})},n.file=function(e){var t=new n;return t.file(e)},n}(),te=globalThis&&globalThis.__extends||function(){var n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,i){o.__proto__=i}||function(o,i){for(var r in i)i.hasOwnProperty(r)&&(o[r]=i[r])},n(e,t)};return function(e,t){n(e,t);function o(){this.constructor=e}e.prototype=t===null?Object.create(t):(o.prototype=t.prototype,new o)}}(),ee=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(r){return r instanceof t?r:new t(function(s){s(r)})}return new(t||(t=Promise))(function(r,s){function u(l){try{a(o.next(l))}catch(h){s(h)}}function c(l){try{a(o.throw(l))}catch(h){s(h)}}function a(l){l.done?r(l.value):i(l.value).then(u,c)}a((o=o.apply(n,e||[])).next())})},re=globalThis&&globalThis.__generator||function(n,e){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},o,i,r,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(l){return c([a,l])}}function c(a){if(o)throw new TypeError("Generator is already executing.");for(;t;)try{if(o=1,i&&(r=a[0]&2?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[a[0]&2,r.value]),a[0]){case 0:case 1:r=a;break;case 4:return t.label++,{value:a[1],done:!1};case 5:t.label++,i=a[1],a=[0];continue;case 7:a=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(a[0]===6||a[0]===2)){t=0;continue}if(a[0]===3&&(!r||a[1]>r[0]&&a[1]<r[3])){t.label=a[1];break}if(a[0]===6&&t.label<r[1]){t.label=r[1],r=a;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(a);break}r[2]&&t.ops.pop(),t.trys.pop();continue}a=e.call(n,t)}catch(l){a=[6,l],i=0}finally{o=r=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},K=function(n){te(e,n);function e(){return n!==null&&n.apply(this,arguments)||this}return e.prototype.run=function(){return ee(this,void 0,void 0,function(){var t,o,i,r,s=this;return re(this,function(u){switch(u.label){case 0:return this.logger.info("start run Direct."),t=new FormData,t.append("file",this.file),t.append("token",this.token),this.key!=null&&t.append("key",this.key),t.append("fname",this.putExtra.fname),this.config.checkByServer?[4,Qt.file(this.file)]:[3,2];case 1:o=u.sent(),t.append("crc32",o.toString()),u.label=2;case 2:return this.putExtra.customVars&&(this.logger.info("init customVars."),i=this.putExtra.customVars,Object.keys(i).forEach(function(c){return t.append(c,i[c].toString())}),this.logger.info("customVars inited.")),this.logger.info("formData inited."),[4,Vt(this.uploadHost.getUrl(),t,{onProgress:function(c){s.updateDirectProgress(c.loaded,c.total)},onCreate:function(c){return s.addXhr(c)}})];case 3:return r=u.sent(),this.logger.info("Direct progress finish."),this.finishDirectProgress(),[2,r]}})})},e.prototype.updateDirectProgress=function(t,o){this.progress={total:this.getProgressInfoItem(t,o+1)},this.onData(this.progress)},e.prototype.finishDirectProgress=function(){if(!this.progress){this.logger.warn("progress is null."),this.progress={total:this.getProgressInfoItem(this.file.size,this.file.size)},this.onData(this.progress);return}var t=this.progress.total;this.progress={total:this.getProgressInfoItem(t.loaded+1,t.size)},this.onData(this.progress)},e}(ut);function lt(n,e,t){t===void 0&&(t=3);var o=rt();o.open("POST","https://uplog.qbox.me/log/3"),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.setRequestHeader("Authorization",R(n).Authorization),o.onreadystatechange=function(){o.readyState===4&&o.status!==200&&t>0&&lt(n,e,t-1)};var i=[e.code||"",e.reqId||"",e.host||"",e.remoteIp||"",e.port||"",e.duration||"",e.time||"",e.bytesSent||"",e.upType||"",e.size||""].join(",");o.send(i)}var ne=globalThis&&globalThis.__read||function(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var o=t.call(n),i,r=[],s;try{for(;(e===void 0||e-- >0)&&!(i=o.next()).done;)r.push(i.value)}catch(u){s={error:u}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(s)throw s.error}}return r},D=globalThis&&globalThis.__spread||function(){for(var n=[],e=0;e<arguments.length;e++)n=n.concat(ne(arguments[e]));return n},ie=function(){function n(e,t,o,i){t===void 0&&(t=!0),o===void 0&&(o="OFF"),i===void 0&&(i="UPLOAD"),this.token=e,this.disableReport=t,this.level=o,this.prefix=i,this.id=++n.id}return n.prototype.getPrintPrefix=function(e){return"Qiniu-JS-SDK ["+e+"]["+this.prefix+"#"+this.id+"]:"},n.prototype.report=function(e,t){if(!this.disableReport)try{lt(this.token,e,t)}catch(o){this.warn(o)}},n.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var o=["INFO"];o.includes(this.level)&&console.log.apply(console,D([this.getPrintPrefix("INFO")],e))},n.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var o=["INFO","WARN"];o.includes(this.level)&&console.warn.apply(console,D([this.getPrintPrefix("WARN")],e))},n.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var o=["INFO","WARN","ERROR"];o.includes(this.level)&&console.error.apply(console,D([this.getPrintPrefix("ERROR")],e))},n.id=0,n}(),oe=ie,Z=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(r){return r instanceof t?r:new t(function(s){s(r)})}return new(t||(t=Promise))(function(r,s){function u(l){try{a(o.next(l))}catch(h){s(h)}}function c(l){try{a(o.throw(l))}catch(h){s(h)}}function a(l){l.done?r(l.value):i(l.value).then(u,c)}a((o=o.apply(n,e||[])).next())})},Y=globalThis&&globalThis.__generator||function(n,e){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},o,i,r,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(l){return c([a,l])}}function c(a){if(o)throw new TypeError("Generator is already executing.");for(;t;)try{if(o=1,i&&(r=a[0]&2?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[a[0]&2,r.value]),a[0]){case 0:case 1:r=a;break;case 4:return t.label++,{value:a[1],done:!1};case 5:t.label++,i=a[1],a=[0];continue;case 7:a=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(a[0]===6||a[0]===2)){t=0;continue}if(a[0]===3&&(!r||a[1]>r[0]&&a[1]<r[3])){t.label=a[1];break}if(a[0]===6&&t.label<r[1]){t.label=r[1],r=a;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(a);break}r[2]&&t.ops.pop(),t.trys.pop();continue}a=e.call(n,t)}catch(l){a=[6,l],i=0}finally{o=r=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},ae=globalThis&&globalThis.__read||function(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var o=t.call(n),i,r=[],s;try{for(;(e===void 0||e-- >0)&&!(i=o.next()).done;)r.push(i.value)}catch(u){s={error:u}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(s)throw s.error}}return r},se=globalThis&&globalThis.__spread||function(){for(var n=[],e=0;e<arguments.length;e++)n=n.concat(ae(arguments[e]));return n},A=new Map,ue=function(){function n(e,t){this.host=e,this.protocol=t}return n.prototype.isFrozen=function(){var e=new Date().getTime(),t=A.get(this.host);return t!=null&&t>=e},n.prototype.freeze=function(e){e===void 0&&(e=20);var t=new Date().getTime()+e*1e3;A.set(this.host,t)},n.prototype.unfreeze=function(){A.delete(this.host)},n.prototype.getUrl=function(){return this.protocol+"://"+this.host},n.prototype.getUnfreezeTime=function(){return A.get(this.host)},n}(),le=function(){function n(e){e===void 0&&(e=[]),this.initHosts=e,this.cachedHostsMap=new Map}return n.prototype.register=function(e,t,o,i){this.cachedHostsMap.set(e+"@"+t,o.map(function(r){return new ue(r,i)}))},n.prototype.refresh=function(e,t,o){var i,r,s,u;return Z(this,void 0,void 0,function(){var c,a,l;return Y(this,function(h){switch(h.label){case 0:return c=this.cachedHostsMap.get(e+"@"+t)||[],c.length>0?[2]:this.initHosts.length>0?(this.register(e,t,this.initHosts,o),[2]):[4,at(e,t,o)];case 1:return a=h.sent(),(a==null?void 0:a.data)!=null&&(l=se(((r=(i=a.data.up)===null||i===void 0?void 0:i.acc)===null||r===void 0?void 0:r.main)||[],((u=(s=a.data.up)===null||s===void 0?void 0:s.acc)===null||u===void 0?void 0:u.backup)||[]),this.register(e,t,l,o)),[2]}})})},n.prototype.getUp=function(e,t,o){return Z(this,void 0,void 0,function(){var i,r,s;return Y(this,function(u){switch(u.label){case 0:return[4,this.refresh(e,t,o)];case 1:return u.sent(),i=this.cachedHostsMap.get(e+"@"+t)||[],i.length===0?[2,null]:(r=i.filter(function(c){return!c.isFrozen()}),r.length>0?[2,r[0]]:(s=i.slice().sort(function(c,a){return(c.getUnfreezeTime()||0)-(a.getUnfreezeTime()||0)}),[2,s[0]]))}})})},n}();function ce(n,e,t,o){return n.config&&n.config.forceDirect?(o.info("ues forceDirect mode."),new K(n,e,t,o)):n.file.size>4*x?(o.info("file size over 4M, use Resume."),new Yt(n,e,t,o)):(o.info("file size less or equal than 4M, use Direct."),new K(n,e,t,o))}function Ue(n,e,t,o,i){var r=new oe(t,i==null?void 0:i.disableStatisticsReport,i==null?void 0:i.debugLogLevel,n.name),s={file:n,key:e,token:t,putExtra:o,config:ct(i,r)},u=new le(s.config.uphost);return new yt(function(c){var a=ce(s,{onData:function(l){return c.next(l)},onError:function(l){return c.error(l)},onComplete:function(l){return c.complete(l)}},u,r);return a.putFile(),a.stop.bind(a)})}var k=globalThis&&globalThis.__assign||function(){return k=Object.assign||function(n){for(var e,t=1,o=arguments.length;t<o;t++){e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i])}return n},k.apply(this,arguments)},he=globalThis&&globalThis.__rest||function(n,e){var t={};for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&e.indexOf(o)<0&&(t[o]=n[o]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,o=Object.getOwnPropertySymbols(n);i<o.length;i++)e.indexOf(o[i])<0&&Object.prototype.propertyIsEnumerable.call(n,o[i])&&(t[o[i]]=n[o[i]]);return t},fe=globalThis&&globalThis.__read||function(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var o=t.call(n),i,r=[],s;try{for(;(e===void 0||e-- >0)&&!(i=o.next()).done;)r.push(i.value)}catch(u){s={error:u}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(s)throw s.error}}return r},M=globalThis&&globalThis.__spread||function(){for(var n=[],e=0;e<arguments.length;e++)n=n.concat(fe(arguments[e]));return n};function ct(n,e){var t=k({},n),o=t.upprotocol,i=t.uphost,r=he(t,["upprotocol","uphost"]),s=k({uphost:[],retryCount:3,checkByMD5:!1,forceDirect:!1,useCdnDomain:!0,checkByServer:!1,concurrentRequestLimit:3,chunkSize:Xt,upprotocol:"https",debugLogLevel:"OFF",disableStatisticsReport:!1},r);o&&(s.upprotocol=o.replace(/:$/,""));var u=[];if(e&&(n==null?void 0:n.uphost)!=null&&(n==null?void 0:n.region)!=null&&e.warn("do not use both the uphost and region config."),i)Array.isArray(i)?u.push.apply(u,M(i)):u.push(i);else if(s!=null&&s.region){var c=Dt[s==null?void 0:s.region];s.useCdnDomain?u.push.apply(u,M(c.cdnUphost)):u.push.apply(u,M(c.srcUphost))}return k(k({},s),{uphost:u.filter(Boolean)})}var $=globalThis&&globalThis.__assign||function(){return $=Object.assign||function(n){for(var e,t=1,o=arguments.length;t<o;t++){e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i])}return n},$.apply(this,arguments)},Q=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(r){return r instanceof t?r:new t(function(s){s(r)})}return new(t||(t=Promise))(function(r,s){function u(l){try{a(o.next(l))}catch(h){s(h)}}function c(l){try{a(o.throw(l))}catch(h){s(h)}}function a(l){l.done?r(l.value):i(l.value).then(u,c)}a((o=o.apply(n,e||[])).next())})},tt=globalThis&&globalThis.__generator||function(n,e){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},o,i,r,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(l){return c([a,l])}}function c(a){if(o)throw new TypeError("Generator is already executing.");for(;t;)try{if(o=1,i&&(r=a[0]&2?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[a[0]&2,r.value]),a[0]){case 0:case 1:r=a;break;case 4:return t.label++,{value:a[1],done:!1};case 5:t.label++,i=a[1],a=[0];continue;case 7:a=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(a[0]===6||a[0]===2)){t=0;continue}if(a[0]===3&&(!r||a[1]>r[0]&&a[1]<r[3])){t.label=a[1];break}if(a[0]===6&&t.label<r[1]){t.label=r[1],r=a;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(a);break}r[2]&&t.ops.pop(),t.trys.pop();continue}a=e.call(n,t)}catch(l){a=[6,l],i=0}finally{o=r=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},B={PNG:"image/png",JPEG:"image/jpeg",WEBP:"image/webp",BMP:"image/bmp"},de=4,pe=Math.log(2),ge=Object.keys(B).map(function(n){return B[n]}),ve=B.JPEG;function ye(n){return ge.includes(n)}var me=function(){function n(e,t){this.file=e,this.config=t,this.config=$({quality:.92,noCompressIfLarger:!1},this.config)}return n.prototype.process=function(){return Q(this,void 0,void 0,function(){var e,t,o,i,r,s;return tt(this,function(u){switch(u.label){case 0:if(this.outputType=this.file.type,e={},!ye(this.file.type))throw new p(d.UnsupportedFileType,"unsupported file type: "+this.file.type);return[4,this.getOriginImage()];case 1:return t=u.sent(),[4,this.getCanvas(t)];case 2:return o=u.sent(),i=1,this.config.maxWidth&&(i=Math.min(1,this.config.maxWidth/o.width)),this.config.maxHeight&&(i=Math.min(1,i,this.config.maxHeight/o.height)),e.width=o.width,e.height=o.height,[4,this.doScale(o,i)];case 3:return r=u.sent(),s=this.toBlob(r),s.size>this.file.size&&this.config.noCompressIfLarger?[2,{dist:this.file,width:e.width,height:e.height}]:[2,{dist:s,width:r.width,height:r.height}]}})})},n.prototype.clear=function(e,t,o){this.outputType===ve?(e.fillStyle="#fff",e.fillRect(0,0,t,o)):e.clearRect(0,0,t,o)},n.prototype.getOriginImage=function(){var e=this;return new Promise(function(t,o){var i=Ht(e.file),r=new Image;r.onload=function(){t(r)},r.onerror=function(){o("image load error")},r.src=i})},n.prototype.getCanvas=function(e){var t=this;return new Promise(function(o,i){var r=document.createElement("canvas"),s=r.getContext("2d");if(!s){i(new p(d.GetCanvasContextFailed,"context is null"));return}var u=e.width,c=e.height;r.height=c,r.width=u,t.clear(s,u,c),s.drawImage(e,0,0),o(r)})},n.prototype.doScale=function(e,t){return Q(this,void 0,void 0,function(){var o,i,r,s,u,c,a,l,h,f,g,v,z,F,E,G;return tt(this,function(ke){if(t===1)return[2,e];if(o=e.getContext("2d"),i=Math.min(de,Math.ceil(1/t/pe)),r=Math.pow(t,1/i),s=document.createElement("canvas"),u=s.getContext("2d"),c=e.width,a=e.height,l=c,h=a,s.width=c,s.height=a,!u||!o)throw new p(d.GetCanvasContextFailed,"mctx or sctx can't be null");for(v=0;v<i;v++)z=c*r|0,F=a*r|0,v===i-1&&(z=l*t,F=h*t),v%2===0?(f=e,g=u):(f=s,g=o),this.clear(g,c,a),g.drawImage(f,0,0,c,a,0,0,z,F),c=z,a=F;return E=f===e?s:e,G=g.getImageData(0,0,c,a),E.width=c,E.height=a,g.putImageData(G,0,0),[2,E]})})},n.prototype.toBlob=function(e){var t=e.toDataURL(this.outputType,this.config.quality),o=atob(t.split(",")[1]).split("").map(function(r){return r.charCodeAt(0)}),i=new Blob([new Uint8Array(o)],{type:this.outputType});return i},n}(),be=function(n,e){return new me(n,e).process()},Se=be;function T(n,e){return n=encodeURIComponent(n),e.slice(e.length-1)!=="/"&&(e+="/"),e+n}function we(n,e,t){if(!/^\d$/.test(String(n.mode)))throw"mode should be number in imageView2";var o=n.mode,i=n.w,r=n.h,s=n.q,u=n.format;if(!i&&!r)throw"param w and h is empty in imageView2";var c="imageView2/"+encodeURIComponent(o);return c+=i?"/w/"+encodeURIComponent(i):"",c+=r?"/h/"+encodeURIComponent(r):"",c+=s?"/q/"+encodeURIComponent(s):"",c+=u?"/format/"+encodeURIComponent(u):"",e&&t&&(c=T(e,t)+"?"+c),c}function _e(n,e,t){var o=n["auto-orient"],i=n.thumbnail,r=n.strip,s=n.gravity,u=n.crop,c=n.quality,a=n.rotate,l=n.format,h=n.blur,f="imageMogr2";return f+=o?"/auto-orient":"",f+=i?"/thumbnail/"+encodeURIComponent(i):"",f+=r?"/strip":"",f+=s?"/gravity/"+encodeURIComponent(s):"",f+=c?"/quality/"+encodeURIComponent(c):"",f+=u?"/crop/"+encodeURIComponent(u):"",f+=a?"/rotate/"+encodeURIComponent(a):"",f+=l?"/format/"+encodeURIComponent(l):"",f+=h?"/blur/"+encodeURIComponent(h):"",e&&t&&(f=T(e,t)+"?"+f),f}function xe(n,e,t){var o=n.mode;if(!o)throw"mode can't be empty in watermark";var i="watermark/"+o;if(o!==1&&o!==2)throw"mode is wrong";if(o===1){var r=n.image;if(!r)throw"image can't be empty in watermark";i+=r?"/image/"+_(r):""}if(o===2){var s=n.text,u=n.font,c=n.fontsize,a=n.fill;if(!s)throw"text can't be empty in watermark";i+=s?"/text/"+_(s):"",i+=u?"/font/"+_(u):"",i+=c?"/fontsize/"+c:"",i+=a?"/fill/"+_(a):""}var l=n.dissolve,h=n.gravity,f=n.dx,g=n.dy;return i+=l?"/dissolve/"+encodeURIComponent(l):"",i+=h?"/gravity/"+encodeURIComponent(h):"",i+=f?"/dx/"+encodeURIComponent(f):"",i+=g?"/dy/"+encodeURIComponent(g):"",e&&t&&(i=T(e,t)+"?"+i),i}function Re(n,e){var t=T(n,e)+"?imageInfo";return m(t,{method:"GET"})}function Oe(n,e){var t=T(n,e)+"?exif";return m(t,{method:"GET"})}function ze(n,e,t){var o=Object.prototype.toString.call(n)==="[object Array]",i,r=!1,s="";if(o){for(var u=0,c=n.length;u<c;u++){if(i=n[u],!i.fop)throw"fop can't be empty in pipeline";switch(i.fop){case"watermark":s+=xe(i)+"|";break;case"imageView2":s+=we(i)+"|";break;case"imageMogr2":s+=_e(i)+"|";break;default:r=!0;break}if(r)throw"fop is wrong in pipeline"}if(e&&t){s=T(e,t)+"?"+s;var a=s.length;s.slice(a-1)==="|"&&(s=s.slice(0,a-1))}return s}throw"pipeline's first param should be array"}export{p as QiniuError,d as QiniuErrorName,ft as QiniuNetworkError,S as QiniuRequestError,Se as compressImage,Ce as deleteUploadedChunks,Oe as exif,Ft as getHeadersForChunkUpload,Et as getHeadersForMkFile,Ie as getUploadUrl,Re as imageInfo,_e as imageMogr2,ze as pipeline,w as region,Ue as upload,xt as urlSafeBase64Decode,_ as urlSafeBase64Encode,xe as watermark};
