"use strict";(Object("undefined"!=typeof self?self:this).webpackChunkxyui=Object("undefined"!=typeof self?self:this).webpackChunkxyui||[]).push([[964],{2964:function(t,e,n){n.r(e),n.d(e,{QiniuError:function(){return a},QiniuErrorName:function(){return o},QiniuNetworkError:function(){return u},QiniuRequestError:function(){return s},compressImage:function(){return Bt},deleteUploadedChunks:function(){return V},exif:function(){return Wt},getHeadersForChunkUpload:function(){return P},getHeadersForMkFile:function(){return S},getUploadUrl:function(){return K},imageInfo:function(){return Jt},imageMogr2:function(){return Kt},pipeline:function(){return Qt},region:function(){return T},upload:function(){return Rt},urlSafeBase64Decode:function(){return v},urlSafeBase64Encode:function(){return g},watermark:function(){return Xt}});var r,o,i=(r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},r(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});!function(t){t.InvalidFile="InvalidFile",t.InvalidToken="InvalidToken",t.InvalidMetadata="InvalidMetadata",t.InvalidChunkSize="InvalidChunkSize",t.InvalidCustomVars="InvalidCustomVars",t.NotAvailableUploadHost="NotAvailableUploadHost",t.ReadCacheFailed="ReadCacheFailed",t.InvalidCacheData="InvalidCacheData",t.WriteCacheFailed="WriteCacheFailed",t.RemoveCacheFailed="RemoveCacheFailed",t.GetCanvasContextFailed="GetCanvasContextFailed",t.UnsupportedFileType="UnsupportedFileType",t.FileReaderReadFailed="FileReaderReadFailed",t.NotAvailableXMLHttpRequest="NotAvailableXMLHttpRequest",t.InvalidProgressEventTarget="InvalidProgressEventTarget",t.RequestError="RequestError"}(o||(o={}));var a=function(t,e){this.name=t,this.message=e,this.stack=(new Error).stack},s=function(t){function e(e,n,r,i){var a=t.call(this,o.RequestError,r)||this;return a.code=e,a.reqId=n,a.isRequestError=!0,a.data=i,a}return i(e,t),e}(a),u=function(t){function e(e,n){return void 0===n&&(n=""),t.call(this,0,n,e)||this}return i(e,t),e}(s),c=function(){function t(t,e){this.runTask=t,this.limit=e,this.queue=[],this.processing=[]}return t.prototype.enqueue=function(t){var e=this;return new Promise((function(n,r){e.queue.push({task:t,resolve:n,reject:r}),e.check()}))},t.prototype.run=function(t){var e=this;this.queue=this.queue.filter((function(e){return e!==t})),this.processing.push(t),this.runTask(t.task).then((function(){e.processing=e.processing.filter((function(e){return e!==t})),t.resolve(),e.check()}),(function(e){return t.reject(e)}))},t.prototype.check=function(){var t=this,e=this.processing.length,n=this.limit-e;this.queue.slice(0,n).forEach((function(e){t.run(e)}))},t}(),l=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},t(e,n)};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),h=function(){return h=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},h.apply(this,arguments)},f=function(t){function e(e,n,r){var o=t.call(this)||this;return o.isStopped=!1,o.destination=e&&"object"==typeof e?e:h(h(h({},e&&{next:e}),n&&{error:n}),r&&{complete:r}),o}return l(e,t),e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this))},e.prototype.next=function(t){!this.isStopped&&this.destination.next&&this.destination.next(t)},e.prototype.error=function(t){!this.isStopped&&this.destination.error&&(this.isStopped=!0,this.destination.error(t))},e.prototype.complete=function(t){!this.isStopped&&this.destination.complete&&(this.isStopped=!0,this.destination.complete(t))},e}(function(){function t(){this.closed=!1}return t.prototype.unsubscribe=function(){this.closed||(this.closed=!0,this._unsubscribe&&this._unsubscribe())},t.prototype.add=function(t){this._unsubscribe=t},t}()),p=function(){function t(t){this._subscribe=t}return t.prototype.subscribe=function(t,e,n){var r=new f(t,e,n);return r.add(this._subscribe(r)),r},t}();function d(t){var e,n,r,o,i,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s=0,u=0,c="",l=[];if(!t)return t;t=function(t){if(null==t)return"";var e,n,r,o=t+"",i="";e=n=0,r=o.length;for(var a=0;a<r;a++){var s=o.charCodeAt(a),u=null;if(s<128)n++;else if(s>127&&s<2048)u=String.fromCharCode(s>>6|192,63&s|128);else if((63488&s^55296)>0)u=String.fromCharCode(s>>12|224,s>>6&63|128,63&s|128);else{if((64512&s^55296)>0)throw new RangeError("Unmatched trail surrogate at "+a);var c=o.charCodeAt(++a);if((64512&c^56320)>0)throw new RangeError("Unmatched lead surrogate at "+(a-1));s=((1023&s)<<10)+(1023&c)+65536,u=String.fromCharCode(s>>18|240,s>>12&63|128,s>>6&63|128,63&s|128)}null!==u&&(n>e&&(i+=o.slice(e,n)),i+=u,e=n=a+1)}return n>e&&(i+=o.slice(e,r)),i}(t+"");do{e=(i=t.charCodeAt(s++)<<16|t.charCodeAt(s++)<<8|t.charCodeAt(s++))>>18&63,n=i>>12&63,r=i>>6&63,o=63&i,l[u++]=a.charAt(e)+a.charAt(n)+a.charAt(r)+a.charAt(o)}while(s<t.length);switch(c=l.join(""),t.length%3){case 1:c=c.slice(0,-2)+"==";break;case 2:c=c.slice(0,-1)+"="}return c}function y(t){var e,n,r,o,i,a,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u=0,c=0,l=[];if(!t)return t;t+="";do{e=(a=s.indexOf(t.charAt(u++))<<18|s.indexOf(t.charAt(u++))<<12|(o=s.indexOf(t.charAt(u++)))<<6|(i=s.indexOf(t.charAt(u++))))>>16&255,n=a>>8&255,r=255&a,l[c++]=64===o?String.fromCharCode(e):64===i?String.fromCharCode(e,n):String.fromCharCode(e,n,r)}while(u<t.length);return function(t){var e=[],n=0,r=0,o=0;for(t+="";n<t.length;){o=0,(r=255&t.charCodeAt(n))<=191?(r&=127,o=1):r<=223?(r&=31,o=2):r<=239?(r&=15,o=3):(r&=7,o=4);for(var i=1;i<o;++i)r=r<<6|63&t.charCodeAt(i+n);4===o?(r-=65536,e.push(String.fromCharCode(55296|r>>10&1023)),e.push(String.fromCharCode(56320|1023&r))):e.push(String.fromCharCode(r)),n+=o}return e.join("")}(l.join(""))}function g(t){return(t=d(t)).replace(/\//g,"_").replace(/\+/g,"-")}function v(t){return y(t=t.replace(/_/g,"/").replace(/-/g,"+"))}var m,b=n(8322),w=n.n(b),k=function(){return k=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},k.apply(this,arguments)},x=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{u(r.next(t))}catch(t){i(t)}}function s(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}u((r=r.apply(t,e||[])).next())}))},C=function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},I=Math.pow(1024,2);function U(t,e){try{localStorage.removeItem(t)}catch(n){e.warn(new a(o.RemoveCacheFailed,"removeLocalFileInfo failed. key: "+t))}}function O(t){return{Authorization:"UpToken "+t}}function P(t){var e=O(t);return k({"content-type":"application/octet-stream"},e)}function S(t){var e=O(t);return k({"content-type":"application/json"},e)}function R(){if(window.XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)return new window.ActiveXObject("Microsoft.XMLHTTP");throw new a(o.NotAvailableXMLHttpRequest,"the current environment does not support.")}function z(t){return x(this,void 0,void 0,(function(){var e,n;return C(this,(function(r){switch(r.label){case 0:return[4,E(t)];case 1:return e=r.sent(),(n=new(w().ArrayBuffer)).append(e),[2,n.end()]}}))}))}function E(t){return new Promise((function(e,n){var r=new FileReader;r.onload=function(t){if(t.target){var r=t.target.result;e(r)}else n(new a(o.InvalidProgressEventTarget,"progress event target is undefined"))},r.onerror=function(){n(new a(o.FileReaderReadFailed,"fileReader read failed"))},r.readAsArrayBuffer(t)}))}function A(t,e){return new Promise((function(n,r){var o=R();if(o.open(e.method,t),e.onCreate&&e.onCreate(o),e.headers){var i=e.headers;Object.keys(i).forEach((function(t){o.setRequestHeader(t,i[t])}))}o.upload.addEventListener("progress",(function(t){t.lengthComputable&&e.onProgress&&e.onProgress({loaded:t.loaded,total:t.total})})),o.onreadystatechange=function(){var t=o.responseText;if(4===o.readyState){var e=o.getResponseHeader("x-reqId")||"";if(0!==o.status)if(200===o.status)try{n({data:JSON.parse(t),reqId:e})}catch(t){r(t)}else{var i="xhr request failed, code: "+o.status;t&&(i+=" response: "+t);var a=void 0;try{a=JSON.parse(t)}catch(t){}r(new s(o.status,e,i,a))}else r(new u("network error.",e))}},o.send(e.body)}))}function F(t){if(t&&t.match){var e=t.match(/(^https?)/);if(!e)return"";var n=e[1];return(e=t.match(/^https?:\/\/([^:^/]*):(\d*)/))?e[2]:"http"===n?"80":"443"}return""}function j(t){if(t&&t.match){var e=t.match(/^https?:\/\/([^:^/]*)/);return e?e[1]:""}return""}function q(t){if(!t)throw new a(o.InvalidToken,"invalid token.");var e=t.split(":");if(1===e.length)throw new a(o.InvalidToken,"invalid token segments.");var n=e.length>3?e[1]:e[0];if(!n)throw new a(o.InvalidToken,"missing assess key field.");var r=null;try{r=JSON.parse(v(e[e.length-1]))}catch(t){throw new a(o.InvalidToken,"token parse failed.")}if(null==r)throw new a(o.InvalidToken,"putPolicy is null.");if(null==r.scope)throw new a(o.InvalidToken,"scope field is null.");var i=r.scope.split(":")[0];if(!i)throw new a(o.InvalidToken,"resolve bucketName failed.");return{assessKey:n,bucketName:i,scope:r.scope}}var T={z0:"z0",z1:"z1",z2:"z2",na0:"na0",as0:"as0",cnEast2:"cn-east-2"},L=((m={})[T.z0]={srcUphost:["up.qiniup.com"],cdnUphost:["upload.qiniup.com"]},m[T.z1]={srcUphost:["up-z1.qiniup.com"],cdnUphost:["upload-z1.qiniup.com"]},m[T.z2]={srcUphost:["up-z2.qiniup.com"],cdnUphost:["upload-z2.qiniup.com"]},m[T.na0]={srcUphost:["up-na0.qiniup.com"],cdnUphost:["upload-na0.qiniup.com"]},m[T.as0]={srcUphost:["up-as0.qiniup.com"],cdnUphost:["upload-as0.qiniup.com"]},m[T.cnEast2]={srcUphost:["up-cn-east-2.qiniup.com"],cdnUphost:["upload-cn-east-2.qiniup.com"]},m),_=n(7673),H=function(){return H=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},H.apply(this,arguments)},M=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{u(r.next(t))}catch(t){i(t)}}function s(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}u((r=r.apply(t,e||[])).next())}))},D=function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};function N(t,e,n){return M(this,void 0,void 0,(function(){var r;return D(this,(function(o){return r=(0,_.stringify)({ak:t,bucket:e}),[2,A(n+"://api.qiniu.com/v2/query?"+r,{method:"GET"})]}))}))}function B(t,e,n){var r=n.url,o=n.id;return r+"/buckets/"+t+"/objects/"+(null!=e?g(e):"~")+"/uploads/"+o}function G(t,e,n,r,o){var i=B(q(t).bucketName,e,r)+"/"+n,a=P(t);return o.md5&&(a["Content-MD5"]=o.md5),A(i,H(H({},o),{method:"PUT",headers:a}))}function V(t,e,n){return A(B(q(t).bucketName,e,n),{method:"DELETE",headers:O(t)})}function K(t,e){return M(this,void 0,void 0,(function(){var n,r,o,i,a;return D(this,(function(s){switch(s.label){case 0:return n=jt(t),r=n.upprotocol,n.uphost.length>0?[2,r+"://"+n.uphost[0]]:[4,N((o=q(e)).assessKey,o.bucketName,r)];case 1:return i=s.sent(),a=i.data.up.acc.main,[2,r+"://"+a[0]]}}))}))}var X=function(){return X=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},X.apply(this,arguments)},J=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{u(r.next(t))}catch(t){i(t)}}function s(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}u((r=r.apply(t,e||[])).next())}))},W=function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},Q=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},$=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(Q(arguments[e]));return t},Y=[0,502,503,504,599],Z=$(Y,[612]),tt=Math.pow(1024,3),et=function(){function t(t,e,n,r){this.hostPool=n,this.logger=r,this.aborted=!1,this.retryCount=0,this.xhrList=[],this.config=t.config,r.info("config inited.",this.config),this.putExtra=X({fname:""},t.putExtra),r.info("putExtra inited.",this.putExtra),this.key=t.key,this.file=t.file,this.token=t.token,this.onData=e.onData,this.onError=e.onError,this.onComplete=e.onComplete;try{var o=q(this.token);this.bucketName=o.bucketName,this.assessKey=o.assessKey}catch(t){r.error("get putPolicy from token failed.",t),this.onError(t)}}return t.prototype.checkAndUpdateUploadHost=function(){return J(this,void 0,void 0,(function(){var t;return W(this,(function(e){switch(e.label){case 0:return this.logger.info("get available upload host."),[4,this.hostPool.getUp(this.assessKey,this.bucketName,this.config.upprotocol)];case 1:if(null==(t=e.sent()))throw new a(o.NotAvailableUploadHost,"no available upload host.");return null!=this.uploadHost&&this.uploadHost.host!==t.host?this.logger.warn("host switches from "+this.uploadHost.host+" to "+t.host+"."):this.logger.info("use host "+t.host+"."),this.uploadHost=t,[2]}}))}))},t.prototype.checkAndUnfreezeHost=function(){this.logger.info("check unfreeze host."),null!=this.uploadHost&&this.uploadHost.isFrozen()&&(this.logger.warn(this.uploadHost.host+" will be unfrozen."),this.uploadHost.unfreeze())},t.prototype.checkAndFreezeHost=function(t){this.logger.info("check freeze host."),t instanceof s&&null!=this.uploadHost&&Y.includes(t.code)&&(this.logger.warn(this.uploadHost.host+" will be temporarily frozen."),this.uploadHost.freeze())},t.prototype.handleError=function(t){this.logger.error(t.message),this.onError(t)},t.prototype.putFile=function(){return J(this,void 0,void 0,(function(){var t,e,n,r,i;return W(this,(function(u){switch(u.label){case 0:if(this.aborted=!1,this.putExtra.fname||(this.logger.info("use file.name as fname."),this.putExtra.fname=this.file.name),this.file.size>1e4*tt)return this.handleError(new a(o.InvalidFile,"file size exceed maximum value 10000G")),[2];if(this.putExtra.customVars&&(c=this.putExtra.customVars,!Object.keys(c).every((function(t){return 0===t.indexOf("x:")}))))return this.handleError(new a(o.InvalidCustomVars,"customVars key should start width x:")),[2];if(this.putExtra.metadata&&!function(t){return Object.keys(t).every((function(t){return 0===t.indexOf("x-qn-meta-")}))}(this.putExtra.metadata))return this.handleError(new a(o.InvalidMetadata,"metadata key should start with x-qn-meta-")),[2];u.label=1;case 1:return u.trys.push([1,4,,5]),this.uploadAt=(new Date).getTime(),[4,this.checkAndUpdateUploadHost()];case 2:return u.sent(),[4,this.run()];case 3:return t=u.sent(),this.onComplete(t.data),this.checkAndUnfreezeHost(),this.sendLog(t.reqId,200),[2];case 4:return e=u.sent(),this.logger.error(e),this.clear(),e instanceof s&&(n=this.aborted?"":e.reqId,r=this.aborted?-2:e.code,this.sendLog(n,r),this.checkAndFreezeHost(e),i=++this.retryCount<=this.config.retryCount,!this.aborted&&Z.includes(e.code)&&i)?(this.logger.warn("error auto retry: "+this.retryCount+"/"+this.config.retryCount+"."),this.putFile(),[2]):(this.onError(e),[3,5]);case 5:return[2]}var c}))}))},t.prototype.clear=function(){this.logger.info("start cleaning all xhr."),this.xhrList.forEach((function(t){t.onreadystatechange=null,t.abort()})),this.logger.info("cleanup completed."),this.xhrList=[]},t.prototype.stop=function(){this.logger.info("stop."),this.clear(),this.aborted=!0},t.prototype.addXhr=function(t){this.xhrList.push(t)},t.prototype.sendLog=function(t,e){var n,r;this.logger.report({code:e,reqId:t,remoteIp:"",upType:"jssdk-h5",size:this.file.size,time:Math.floor(this.uploadAt/1e3),port:F(null===(n=this.uploadHost)||void 0===n?void 0:n.getUrl()),host:j(null===(r=this.uploadHost)||void 0===r?void 0:r.getUrl()),bytesSent:this.progress?this.progress.total.loaded:0,duration:Math.floor(((new Date).getTime()-this.uploadAt)/1e3)})},t.prototype.getProgressInfoItem=function(t,e,n){return X({size:e,loaded:t,percent:t/e*100},null==n?{}:{fromCache:n})},t}(),nt=et,rt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},t(e,n)};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ot=function(){return ot=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},ot.apply(this,arguments)},it=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{u(r.next(t))}catch(t){i(t)}}function s(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}u((r=r.apply(t,e||[])).next())}))},at=function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};var st=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return rt(e,t),e.prototype.run=function(){return it(this,void 0,void 0,(function(){var t,e,n,r,i,u=this;return at(this,(function(l){switch(l.label){case 0:if(this.logger.info("start run Resume."),!this.config.chunkSize||(h=this.config.chunkSize,!/^[1-9]\d*$/.test(String(h))))throw new a(o.InvalidChunkSize,"chunkSize must be a positive integer");if(this.config.chunkSize>1024)throw new a(o.InvalidChunkSize,"chunkSize maximum value is 1024");return[4,this.initBeforeUploadChunks()];case 1:l.sent(),t=new c((function(t){return u.uploadChunk(t)}),this.config.concurrentRequestLimit),e=null,n=this.getLocalKey(),r=this.chunks.map((function(e,n){return t.enqueue({chunk:e,index:n})})),l.label=2;case 2:return l.trys.push([2,5,,6]),[4,Promise.all(r)];case 3:return l.sent(),[4,this.mkFileReq()];case 4:return e=l.sent(),[3,6];case 5:throw(i=l.sent())instanceof s&&(612===i.code||400===i.code)&&U(n,this.logger),i;case 6:return U(n,this.logger),[2,e]}var h}))}))},e.prototype.uploadChunk=function(t){return it(this,void 0,void 0,(function(){var e,n,r,o,i,a,s,u,c,l=this;return at(this,(function(h){switch(h.label){case 0:return e=t.index,n=t.chunk,r=this.cachedUploadedList[e],this.logger.info("upload part "+e+", cache:",r),o=this.config.checkByMD5,i=function(){l.usedCacheList[e]=!0,l.updateChunkProgress(n.size,e),l.uploadedList[e]=r,l.updateLocalCache()},r&&!o?(i(),[2]):[4,z(n)];case 1:return a=h.sent(),this.logger.info("computed part md5.",a),r&&a===r.md5?(i(),[2]):(this.usedCacheList[e]=!1,s=function(t){l.updateChunkProgress(t.loaded,e)},u={body:n,md5:this.config.checkByServer?a:void 0,onProgress:s,onCreate:function(t){return l.addXhr(t)}},this.logger.info("part "+e+" start uploading."),[4,G(this.token,this.key,t.index+1,this.getUploadInfo(),u)]);case 2:return c=h.sent(),this.logger.info("part "+e+" upload completed."),s({loaded:n.size,total:n.size}),this.uploadedList[e]={etag:c.data.etag,md5:c.data.md5,size:n.size},this.updateLocalCache(),[2]}}))}))},e.prototype.mkFileReq=function(){return it(this,void 0,void 0,(function(){var t,e,n=this;return at(this,(function(r){switch(r.label){case 0:return t=ot(ot(ot({parts:this.uploadedList.map((function(t,e){return{etag:t.etag,partNumber:e+1}})),fname:this.putExtra.fname},this.putExtra.mimeType&&{mimeType:this.putExtra.mimeType}),this.putExtra.customVars&&{customVars:this.putExtra.customVars}),this.putExtra.metadata&&{metadata:this.putExtra.metadata}),this.logger.info("parts upload completed, make file.",t),[4,(o=this.token,i=this.key,a=this.getUploadInfo(),s={onCreate:function(t){return n.addXhr(t)},body:JSON.stringify(t)},A(B(q(o).bucketName,i,a),H(H({},s),{method:"POST",headers:S(o)})))];case 1:return e=r.sent(),this.logger.info("finish Resume Progress."),this.updateMkFileProgress(1),[2,e]}var o,i,a,s}))}))},e.prototype.initBeforeUploadChunks=function(){return it(this,void 0,void 0,(function(){var t,e,n;return at(this,(function(r){switch(r.label){case 0:return this.uploadedList=[],this.usedCacheList=[],(t=function(t,e){var n=null;try{n=localStorage.getItem(t)}catch(n){e.warn(new a(o.ReadCacheFailed,"getLocalFileInfo failed. key: "+t))}if(null==n)return null;var r=null;try{r=JSON.parse(n)}catch(n){U(t,e),e.warn(new a(o.InvalidCacheData,"getLocalFileInfo failed to parse. key: "+t))}return r}(this.getLocalKey(),this.logger))?[3,2]:(this.logger.info("init upload parts from api."),[4,(i=this.token,s=this.bucketName,u=this.key,c=this.uploadHost.getUrl(),A(c+"/buckets/"+s+"/objects/"+(null!=u?g(u):"~")+"/uploads",{method:"POST",headers:O(i)}))]);case 1:return e=r.sent(),this.logger.info("initd upload parts of id: "+e.data.uploadId+"."),this.uploadId=e.data.uploadId,this.cachedUploadedList=[],[3,3];case 2:n=["resume upload parts from local cache,","total "+t.data.length+" part,","id is "+t.id+"."],this.logger.info(n.join(" ")),this.cachedUploadedList=t.data,this.uploadId=t.id,r.label=3;case 3:return this.chunks=function(t,e){var n=e*I;if(n>t.size)n=t.size;else for(;t.size>1e4*n;)n*=2;for(var r=[],o=Math.ceil(t.size/n),i=0;i<o;i++){var a=t.slice(n*i,i===o-1?t.size:n*(i+1));r.push(a)}return r}(this.file,this.config.chunkSize),this.loaded={mkFileProgress:0,chunks:this.chunks.map((function(t){return 0}))},this.notifyResumeProgress(),[2]}var i,s,u,c}))}))},e.prototype.getUploadInfo=function(){return{id:this.uploadId,url:this.uploadHost.getUrl()}},e.prototype.getLocalKey=function(){return t=this.file.name,e=this.key,n=this.file.size,"qiniu_js_sdk_upload_file_name_"+t+(null==e?"_":"_key_"+e+"_")+"size_"+n;var t,e,n},e.prototype.updateLocalCache=function(){!function(t,e,n){try{localStorage.setItem(t,JSON.stringify(e))}catch(e){n.warn(new a(o.WriteCacheFailed,"setLocalFileInfo failed: "+t))}}(this.getLocalKey(),{id:this.uploadId,data:this.uploadedList},this.logger)},e.prototype.updateChunkProgress=function(t,e){this.loaded.chunks[e]=t,this.notifyResumeProgress()},e.prototype.updateMkFileProgress=function(t){this.loaded.mkFileProgress=t,this.notifyResumeProgress()},e.prototype.notifyResumeProgress=function(){var t,e=this;this.progress={total:this.getProgressInfoItem((t=this.loaded.chunks,t.reduce((function(t,e){return t+e}),0)+this.loaded.mkFileProgress),this.file.size+1),chunks:this.chunks.map((function(t,n){var r=e.usedCacheList[n];return e.getProgressInfoItem(e.loaded.chunks[n],t.size,r)})),uploadInfo:{id:this.uploadId,url:this.uploadHost.getUrl()}},this.onData(this.progress)},e}(nt),ut=st,ct=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{u(r.next(t))}catch(t){i(t)}}function s(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}u((r=r.apply(t,e||[])).next())}))},lt=function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},ht=function(){function t(){this.crc=-1,this.table=this.makeTable()}return t.prototype.makeTable=function(){for(var t=new Array,e=0;e<256;e++){for(var n=e,r=0;r<8;r++)1&n?n=n>>>1^3988292384:n>>>=1;t[e]=n}return t},t.prototype.append=function(t){for(var e=this.crc,n=0;n<t.byteLength;n++)e=e>>>8^this.table[255&(e^t[n])];this.crc=e},t.prototype.compute=function(){return(-1^this.crc)>>>0},t.prototype.readAsUint8Array=function(t){return ct(this,void 0,void 0,(function(){var e;return lt(this,(function(n){switch(n.label){case 0:return"function"!=typeof t.arrayBuffer?[3,2]:(e=Uint8Array.bind,[4,t.arrayBuffer()]);case 1:return[2,new(e.apply(Uint8Array,[void 0,n.sent()]))];case 2:return[2,new Promise((function(e,n){var r=new FileReader;r.onload=function(){null!=r.result&&"string"!=typeof r.result?e(new Uint8Array(r.result)):n()},r.readAsArrayBuffer(t)}))]}}))}))},t.prototype.file=function(t){return ct(this,void 0,void 0,(function(){var e,n,r,o,i,a;return lt(this,(function(s){switch(s.label){case 0:return t.size<=I?(e=this.append,[4,this.readAsUint8Array(t)]):[3,2];case 1:return e.apply(this,[s.sent()]),[2,this.compute()];case 2:n=Math.ceil(t.size/I),r=0,s.label=3;case 3:return r<n?(o=r*I,i=r===n-1?t.size:o+I,[4,this.readAsUint8Array(t.slice(o,i))]):[3,6];case 4:a=s.sent(),this.append(new Uint8Array(a)),s.label=5;case 5:return r++,[3,3];case 6:return[2,this.compute()]}}))}))},t.file=function(e){return(new t).file(e)},t}(),ft=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},t(e,n)};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),pt=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{u(r.next(t))}catch(t){i(t)}}function s(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}u((r=r.apply(t,e||[])).next())}))},dt=function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},yt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ft(e,t),e.prototype.run=function(){return pt(this,void 0,void 0,(function(){var t,e,n,r,o=this;return dt(this,(function(i){switch(i.label){case 0:return this.logger.info("start run Direct."),(t=new FormData).append("file",this.file),t.append("token",this.token),null!=this.key&&t.append("key",this.key),t.append("fname",this.putExtra.fname),this.config.checkByServer?[4,ht.file(this.file)]:[3,2];case 1:e=i.sent(),t.append("crc32",e.toString()),i.label=2;case 2:return this.putExtra.customVars&&(this.logger.info("init customVars."),n=this.putExtra.customVars,Object.keys(n).forEach((function(e){return t.append(e,n[e].toString())})),this.logger.info("customVars inited.")),this.logger.info("formData inited."),[4,(a=this.uploadHost.getUrl(),s=t,u={onProgress:function(t){o.updateDirectProgress(t.loaded,t.total)},onCreate:function(t){return o.addXhr(t)}},A(a,H({method:"POST",body:s},u)))];case 3:return r=i.sent(),this.logger.info("Direct progress finish."),this.finishDirectProgress(),[2,r]}var a,s,u}))}))},e.prototype.updateDirectProgress=function(t,e){this.progress={total:this.getProgressInfoItem(t,e+1)},this.onData(this.progress)},e.prototype.finishDirectProgress=function(){if(!this.progress)return this.logger.warn("progress is null."),this.progress={total:this.getProgressInfoItem(this.file.size,this.file.size)},void this.onData(this.progress);var t=this.progress.total;this.progress={total:this.getProgressInfoItem(t.loaded+1,t.size)},this.onData(this.progress)},e}(nt),gt=yt;function vt(t,e,n){void 0===n&&(n=3);var r=R();r.open("POST","https://uplog.qbox.me/log/3"),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.setRequestHeader("Authorization",O(t).Authorization),r.onreadystatechange=function(){4===r.readyState&&200!==r.status&&n>0&&vt(t,e,n-1)};var o=[e.code||"",e.reqId||"",e.host||"",e.remoteIp||"",e.port||"",e.duration||"",e.time||"",e.bytesSent||"",e.upType||"",e.size||""].join(",");r.send(o)}var mt=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},bt=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(mt(arguments[e]));return t},wt=function(){function t(e,n,r,o){void 0===n&&(n=!0),void 0===r&&(r="OFF"),void 0===o&&(o="UPLOAD"),this.token=e,this.disableReport=n,this.level=r,this.prefix=o,this.id=++t.id}return t.prototype.getPrintPrefix=function(t){return"Qiniu-JS-SDK ["+t+"]["+this.prefix+"#"+this.id+"]:"},t.prototype.report=function(t,e){if(!this.disableReport)try{vt(this.token,t,e)}catch(t){this.warn(t)}},t.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=["INFO"];n.includes(this.level)&&console.log.apply(console,bt([this.getPrintPrefix("INFO")],t))},t.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=["INFO","WARN"];n.includes(this.level)&&console.warn.apply(console,bt([this.getPrintPrefix("WARN")],t))},t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=["INFO","WARN","ERROR"];n.includes(this.level)&&console.error.apply(console,bt([this.getPrintPrefix("ERROR")],t))},t.id=0,t}(),kt=wt,xt=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{u(r.next(t))}catch(t){i(t)}}function s(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}u((r=r.apply(t,e||[])).next())}))},Ct=function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},It=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},Ut=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(It(arguments[e]));return t},Ot=new Map,Pt=function(){function t(t,e){this.host=t,this.protocol=e}return t.prototype.isFrozen=function(){var t=(new Date).getTime(),e=Ot.get(this.host);return null!=e&&e>=t},t.prototype.freeze=function(t){void 0===t&&(t=20);var e=(new Date).getTime()+1e3*t;Ot.set(this.host,e)},t.prototype.unfreeze=function(){Ot.delete(this.host)},t.prototype.getUrl=function(){return this.protocol+"://"+this.host},t.prototype.getUnfreezeTime=function(){return Ot.get(this.host)},t}(),St=function(){function t(t){void 0===t&&(t=[]),this.initHosts=t,this.cachedHostsMap=new Map}return t.prototype.register=function(t,e,n,r){this.cachedHostsMap.set(t+"@"+e,n.map((function(t){return new Pt(t,r)})))},t.prototype.refresh=function(t,e,n){var r,o,i,a;return xt(this,void 0,void 0,(function(){var s,u;return Ct(this,(function(c){switch(c.label){case 0:return(this.cachedHostsMap.get(t+"@"+e)||[]).length>0?[2]:this.initHosts.length>0?(this.register(t,e,this.initHosts,n),[2]):[4,N(t,e,n)];case 1:return null!=(null==(s=c.sent())?void 0:s.data)&&(u=Ut((null===(o=null===(r=s.data.up)||void 0===r?void 0:r.acc)||void 0===o?void 0:o.main)||[],(null===(a=null===(i=s.data.up)||void 0===i?void 0:i.acc)||void 0===a?void 0:a.backup)||[]),this.register(t,e,u,n)),[2]}}))}))},t.prototype.getUp=function(t,e,n){return xt(this,void 0,void 0,(function(){var r,o;return Ct(this,(function(i){switch(i.label){case 0:return[4,this.refresh(t,e,n)];case 1:return i.sent(),0===(r=this.cachedHostsMap.get(t+"@"+e)||[]).length?[2,null]:(o=r.filter((function(t){return!t.isFrozen()}))).length>0?[2,o[0]]:[2,r.slice().sort((function(t,e){return(t.getUnfreezeTime()||0)-(e.getUnfreezeTime()||0)}))[0]]}}))}))},t}();function Rt(t,e,n,r,o){var i=new kt(n,null==o?void 0:o.disableStatisticsReport,null==o?void 0:o.debugLogLevel,t.name),a={file:t,key:e,token:n,putExtra:r,config:jt(o,i)},s=new St(a.config.uphost);return new p((function(t){var e=function(t,e,n,r){return t.config&&t.config.forceDirect?(r.info("ues forceDirect mode."),new gt(t,e,n,r)):t.file.size>4*I?(r.info("file size over 4M, use Resume."),new ut(t,e,n,r)):(r.info("file size less or equal than 4M, use Direct."),new gt(t,e,n,r))}(a,{onData:function(e){return t.next(e)},onError:function(e){return t.error(e)},onComplete:function(e){return t.complete(e)}},s,i);return e.putFile(),e.stop.bind(e)}))}var zt=function(){return zt=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},zt.apply(this,arguments)},Et=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]])}return n},At=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},Ft=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(At(arguments[e]));return t};function jt(t,e){var n=zt({},t),r=n.upprotocol,o=n.uphost,i=Et(n,["upprotocol","uphost"]),a=zt({uphost:[],retryCount:3,checkByMD5:!1,forceDirect:!1,useCdnDomain:!0,checkByServer:!1,concurrentRequestLimit:3,chunkSize:4,upprotocol:"https",debugLogLevel:"OFF",disableStatisticsReport:!1},i);r&&(a.upprotocol=r.replace(/:$/,""));var s=[];if(e&&null!=(null==t?void 0:t.uphost)&&null!=(null==t?void 0:t.region)&&e.warn("do not use both the uphost and region config."),o)Array.isArray(o)?s.push.apply(s,Ft(o)):s.push(o);else if(null==a?void 0:a.region){var u=L[null==a?void 0:a.region];a.useCdnDomain?s.push.apply(s,Ft(u.cdnUphost)):s.push.apply(s,Ft(u.srcUphost))}return zt(zt({},a),{uphost:s.filter(Boolean)})}var qt=function(){return qt=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},qt.apply(this,arguments)},Tt=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{u(r.next(t))}catch(t){i(t)}}function s(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}u((r=r.apply(t,e||[])).next())}))},Lt=function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},_t={PNG:"image/png",JPEG:"image/jpeg",WEBP:"image/webp",BMP:"image/bmp"},Ht=Math.log(2),Mt=Object.keys(_t).map((function(t){return _t[t]})),Dt=_t.JPEG;var Nt=function(){function t(t,e){this.file=t,this.config=e,this.config=qt({quality:.92,noCompressIfLarger:!1},this.config)}return t.prototype.process=function(){return Tt(this,void 0,void 0,(function(){var t,e,n,r,i,s;return Lt(this,(function(u){switch(u.label){case 0:if(this.outputType=this.file.type,t={},c=this.file.type,!Mt.includes(c))throw new a(o.UnsupportedFileType,"unsupported file type: "+this.file.type);return[4,this.getOriginImage()];case 1:return e=u.sent(),[4,this.getCanvas(e)];case 2:return n=u.sent(),r=1,this.config.maxWidth&&(r=Math.min(1,this.config.maxWidth/n.width)),this.config.maxHeight&&(r=Math.min(1,r,this.config.maxHeight/n.height)),t.width=n.width,t.height=n.height,[4,this.doScale(n,r)];case 3:return i=u.sent(),(s=this.toBlob(i)).size>this.file.size&&this.config.noCompressIfLarger?[2,{dist:this.file,width:t.width,height:t.height}]:[2,{dist:s,width:i.width,height:i.height}]}var c}))}))},t.prototype.clear=function(t,e,n){this.outputType===Dt?(t.fillStyle="#fff",t.fillRect(0,0,e,n)):t.clearRect(0,0,e,n)},t.prototype.getOriginImage=function(){var t=this;return new Promise((function(e,n){var r,o=(r=t.file,(window.URL||window.webkitURL||window.mozURL).createObjectURL(r)),i=new Image;i.onload=function(){e(i)},i.onerror=function(){n("image load error")},i.src=o}))},t.prototype.getCanvas=function(t){var e=this;return new Promise((function(n,r){var i=document.createElement("canvas"),s=i.getContext("2d");if(s){var u=t.width,c=t.height;i.height=c,i.width=u,e.clear(s,u,c),s.drawImage(t,0,0),n(i)}else r(new a(o.GetCanvasContextFailed,"context is null"))}))},t.prototype.doScale=function(t,e){return Tt(this,void 0,void 0,(function(){var n,r,i,s,u,c,l,h,f,p,d,y,g,v,m,b;return Lt(this,(function(w){if(1===e)return[2,t];if(n=t.getContext("2d"),r=Math.min(4,Math.ceil(1/e/Ht)),i=Math.pow(e,1/r),s=document.createElement("canvas"),u=s.getContext("2d"),c=t.width,l=t.height,h=c,f=l,s.width=c,s.height=l,!u||!n)throw new a(o.GetCanvasContextFailed,"mctx or sctx can't be null");for(y=0;y<r;y++)g=c*i|0,v=l*i|0,y===r-1&&(g=h*e,v=f*e),y%2==0?(p=t,d=u):(p=s,d=n),this.clear(d,c,l),d.drawImage(p,0,0,c,l,0,0,g,v),c=g,l=v;return m=p===t?s:t,b=d.getImageData(0,0,c,l),m.width=c,m.height=l,d.putImageData(b,0,0),[2,m]}))}))},t.prototype.toBlob=function(t){var e=t.toDataURL(this.outputType,this.config.quality),n=atob(e.split(",")[1]).split("").map((function(t){return t.charCodeAt(0)}));return new Blob([new Uint8Array(n)],{type:this.outputType})},t}(),Bt=function(t,e){return new Nt(t,e).process()};function Gt(t,e){return t=encodeURIComponent(t),"/"!==e.slice(e.length-1)&&(e+="/"),e+t}function Vt(t,e,n){if(!/^\d$/.test(String(t.mode)))throw"mode should be number in imageView2";var r=t.mode,o=t.w,i=t.h,a=t.q,s=t.format;if(!o&&!i)throw"param w and h is empty in imageView2";var u="imageView2/"+encodeURIComponent(r);return u+=o?"/w/"+encodeURIComponent(o):"",u+=i?"/h/"+encodeURIComponent(i):"",u+=a?"/q/"+encodeURIComponent(a):"",u+=s?"/format/"+encodeURIComponent(s):"",e&&n&&(u=Gt(e,n)+"?"+u),u}function Kt(t,e,n){var r=t["auto-orient"],o=t.thumbnail,i=t.strip,a=t.gravity,s=t.crop,u=t.quality,c=t.rotate,l=t.format,h=t.blur,f="imageMogr2";return f+=r?"/auto-orient":"",f+=o?"/thumbnail/"+encodeURIComponent(o):"",f+=i?"/strip":"",f+=a?"/gravity/"+encodeURIComponent(a):"",f+=u?"/quality/"+encodeURIComponent(u):"",f+=s?"/crop/"+encodeURIComponent(s):"",f+=c?"/rotate/"+encodeURIComponent(c):"",f+=l?"/format/"+encodeURIComponent(l):"",f+=h?"/blur/"+encodeURIComponent(h):"",e&&n&&(f=Gt(e,n)+"?"+f),f}function Xt(t,e,n){var r=t.mode;if(!r)throw"mode can't be empty in watermark";var o="watermark/"+r;if(1!==r&&2!==r)throw"mode is wrong";if(1===r){var i=t.image;if(!i)throw"image can't be empty in watermark";o+=i?"/image/"+g(i):""}if(2===r){var a=t.text,s=t.font,u=t.fontsize,c=t.fill;if(!a)throw"text can't be empty in watermark";o+=a?"/text/"+g(a):"",o+=s?"/font/"+g(s):"",o+=u?"/fontsize/"+u:"",o+=c?"/fill/"+g(c):""}var l=t.dissolve,h=t.gravity,f=t.dx,p=t.dy;return o+=l?"/dissolve/"+encodeURIComponent(l):"",o+=h?"/gravity/"+encodeURIComponent(h):"",o+=f?"/dx/"+encodeURIComponent(f):"",o+=p?"/dy/"+encodeURIComponent(p):"",e&&n&&(o=Gt(e,n)+"?"+o),o}function Jt(t,e){return A(Gt(t,e)+"?imageInfo",{method:"GET"})}function Wt(t,e){return A(Gt(t,e)+"?exif",{method:"GET"})}function Qt(t,e,n){var r,o=!1,i="";if("[object Array]"===Object.prototype.toString.call(t)){for(var a=0,s=t.length;a<s;a++){if(!(r=t[a]).fop)throw"fop can't be empty in pipeline";switch(r.fop){case"watermark":i+=Xt(r)+"|";break;case"imageView2":i+=Vt(r)+"|";break;case"imageMogr2":i+=Kt(r)+"|";break;default:o=!0}if(o)throw"fop is wrong in pipeline"}if(e&&n){var u=(i=Gt(e,n)+"?"+i).length;"|"===i.slice(u-1)&&(i=i.slice(0,u-1))}return i}throw"pipeline's first param should be array"}},2587:function(t){function e(t,e){return Object.prototype.hasOwnProperty.call(t,e)}t.exports=function(t,n,r,o){n=n||"&",r=r||"=";var i={};if("string"!=typeof t||0===t.length)return i;var a=/\+/g;t=t.split(n);var s=1e3;o&&"number"==typeof o.maxKeys&&(s=o.maxKeys);var u=t.length;s>0&&u>s&&(u=s);for(var c=0;c<u;++c){var l,h,f,p,d=t[c].replace(a,"%20"),y=d.indexOf(r);y>=0?(l=d.substr(0,y),h=d.substr(y+1)):(l=d,h=""),f=decodeURIComponent(l),p=decodeURIComponent(h),e(i,f)?Array.isArray(i[f])?i[f].push(p):i[f]=[i[f],p]:i[f]=p}return i}},2361:function(t){var e=function(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}};t.exports=function(t,n,r,o){return n=n||"&",r=r||"=",null===t&&(t=void 0),"object"==typeof t?Object.keys(t).map((function(o){var i=encodeURIComponent(e(o))+r;return Array.isArray(t[o])?t[o].map((function(t){return i+encodeURIComponent(e(t))})).join(n):i+encodeURIComponent(e(t[o]))})).filter(Boolean).join(n):o?encodeURIComponent(e(o))+r+encodeURIComponent(e(t)):""}},7673:function(t,e,n){n(2587),e.stringify=n(2361)}}]);