import{_ as e}from"./_plugin-vue_export-helper-1b428a4d.js";import{u as t}from"../index-4674eb52.js";import"./preload-helper-17f83b6a.js";import"./index-fd1f8ac9.js";import"./xy-builder-col-624256b6.js";import"./util-f372957a.js";import"./xy-builder-form-56b5876f.js";import"./xy-builder-info-c11e8980.js";import"./button-0f185190.js";import"./xy-builder-list-419ddace.js";import"./xy-builder-remote-d041e3f0.js";import"./xy-builder-stack-7632ac0e.js";import"./xy-builder-tab-8ff297d0.js";const i={props:{apiSeed:{type:String,default:"/v1/qrlogin/qrlogin/getSeed"},qrurlPrefix:{type:String,default:""},qrloginShow:!1},data:()=>({seed:"",qrurl:"",timer:null,timeout:!1}),created:function(){this.loadData()},watch:{qrloginShow(e){e?this.qrurl&&(this.timer=setInterval(this.getLogin,2e3)):clearInterval(this.timer)}},beforeDestroy(){clearInterval(this.timer)},methods:{async loadData(){let e=await this.$xyutil.request({url:this.apiSeed,data:{qrurlPrefix:this.qrurlPrefix},method:"get"});200==e.code?(this.seed=e.data.seed,this.qrurl=e.data.qrurl,this.timeout=!1,clearInterval(this.timer),this.timer=setInterval(this.getLogin,2e3)):this.$xyutil.showToast({title:e.msg,icon:"loading",duration:3e3})},async getLogin(){let e=await this.$xyutil.request({url:"/v1/qrlogin/qrlogin/getLogin?seed="+this.seed,method:"get"});200==e.code&&(e.data.timeout?(this.timeout=!0,clearInterval(this.timer)):(clearInterval(this.timer),this.$store.commit("user/setToken",e.data.token),this.$store.commit("user/setUserInfo",e.data.userInfo),this.$xyutil.showToast({title:e.msg,icon:"success",duration:2e3}),this.$xyutil.switchTab({url:"/"})))}}},o=window.Vue.resolveComponent,a=window.Vue.normalizeStyle,l=window.Vue.openBlock,n=window.Vue.createBlock,s=window.Vue.createCommentVNode,r=window.Vue.createElementBlock,u=window.Vue.createElementVNode;window.Vue.pushScopeId,window.Vue.popScopeId;const d={key:1,class:"xyicon xyicon-history"};const c={components:{qrlogin:e(i,[["render",function(e,t,i,c,p,h){const g=o("xy-qrcode");return l(),r("div",{class:"qr-box",onClick:t[0]||(t[0]=(...e)=>h.loadData&&h.loadData(...e))},[u("div",null,[p.qrurl?(l(),n(g,{key:0,class:"qrcode",style:a({opacity:p.timeout?.3:1}),value:p.qrurl,options:{width:258}},null,8,["style","value"])):s("",!0),p.timeout?(l(),r("span",d)):s("",!0)])])}],["__scopeId","data-v-ef0c7c13"]])},data(){var e,i,o,a;return{supportQrlogin:!1,qrloginShow:!1,activeData:"",srvList:t.getSrvList(),showSrvlist:!1,baseUrl:"",admin2step:"",login:{loading:!1,account:"",password:"",googleAuth:"",mobileVerify:"",emailVerify:"",captchaVerify:""},loginRule:{account:[{required:!0,message:"请填写账号",trigger:"blur"}],password:[{required:!0,message:"请填写密码",trigger:"blur"},{type:"string",min:6,message:"密码至少6位",trigger:"blur"}]},useVerify:null==(a=null==(o=null==(i=null==(e=this.activeData)?void 0:e.app)?void 0:i.apiInfo)?void 0:o.config)?void 0:a.useVerify}},async created(){var e,t,i,o;this.$xyutil.getStorageSync("account")&&(this.login.account=this.$xyutil.getStorageSync("account"),this.login.password=this.$xyutil.getStorageSync("password")),this.baseUrl=this.$xyutil.getStorageSync("xyadmin-active"),this.$route.query.mul?(this.showSrvlist=!0,this.baseUrl||(this.baseUrl=window.location.protocol+"//"+window.location.host+window.location.pathname+"api")):this.baseUrl=window.location.protocol+"//"+window.location.host+window.location.pathname+"api",await this.getSiteInfo(),this.useVerify=null==(o=null==(i=null==(t=null==(e=this.activeData)?void 0:e.app)?void 0:t.apiInfo)?void 0:i.config)?void 0:o.useVerify,this.activeData.app.apiInfo.qrlogin&&(this.supportQrlogin=!0,this.activeData.app.apiInfo.qrlogin.isDefault&&(this.qrloginShow=!0))},methods:{bindPickerChange:function(e){e&&(this.baseUrl=e)},verifySuccess(e){this.login.captchaVerify=e,this.loginSubmit()},useVerifyShow(){this.$refs.verify&&this.$refs.verify.show()},async handleSubmit(){await this.getSiteInfo(),this.activeData.app.apiInfo.config&&this.activeData.app.apiInfo.config.useVerify?this.useVerifyShow():this.loginSubmit()},async getSiteInfo(){if(this.baseUrl)if(this.$xyutil.setStorageSync("xyadmin-active",this.baseUrl),this.activeData=this.$xyutil.getStorageSync("xyadmin-vuex-"+this.baseUrl),this.activeData||(this.activeData=this.$xyutil.getStorageSync("xyadmin-vuex-default")),this.activeData){this.activeData=JSON.parse(this.activeData);let e=await this.$xyutil.request({url:this.baseUrl,method:"get"});if(200!=e.code)return this.$xyutil.showToast({title:"接口异常，请检查服务器接口！",icon:"loading",duration:2e3}),!1;e.data.api.urlLogin&&(window.location.href=e.data.api.urlLogin),this.activeData.app.apiInfo=e.data,e.data.siteInfo&&(e.data.siteInfo.admin2step&&(this.admin2step=e.data.siteInfo.admin2step.login[0]),this.activeData.app.baseUrl=this.baseUrl,this.activeData.app.siteInfo=e.data.siteInfo)}else alert("不存在xyadmin-vuex-default")},loginSubmit:async function(){this.login.loading=!0;let e=this;setTimeout((function(){e.login.loading=!1}),5e3);let t=await this.$xyutil.request({url:this.activeData.app.apiInfo.api.apiBase+this.activeData.app.apiInfo.api.apiLogin,data:this.login,method:"post"});200==t.code?(this.activeData.user.token=t.data.token,this.activeData.user.userInfo=t.data.userInfo,this.activeData.menu.menuList="",this.$xyutil.showToast({title:t.msg,icon:"success",duration:1e3}),this.$xyutil.setStorageSync("xyadmin-vuex-"+this.baseUrl,JSON.stringify(this.activeData)),this.$xyutil.reLaunch()):this.$xyutil.showToast({title:t.msg,icon:"loading",duration:3e3}),this.login.loading=!1}}},p=window.Vue.resolveComponent,h=window.Vue.createVNode,g=window.Vue.createElementVNode,m=window.Vue.toDisplayString,w=window.Vue.renderList,f=window.Vue.Fragment,y=window.Vue.openBlock,v=window.Vue.createElementBlock,x=window.Vue.createBlock,S=window.Vue.withCtx,b=window.Vue.withKeys,V=window.Vue.vShow,q=window.Vue.withDirectives,I=window.Vue.createTextVNode,D=window.Vue.createCommentVNode,k=window.Vue.pushScopeId,$=window.Vue.popScopeId,U={class:"wrap"},_={style:{width:"100%",color:"#fff","margin-bottom":"30px"}},j=["src"],L={key:0,class:"qrlogin-modal"},C={class:"flex space-between m-b"},T=(e=>(k("data-v-55e6cf5b"),e=e(),$(),e))((()=>g("div",null,null,-1))),N={class:"text-center m-t"};const P=e(c,[["render",function(e,t,i,o,a,l){const n=p("vue-particles"),s=p("el-option"),r=p("el-select"),u=p("el-input"),d=p("el-form-item"),c=p("el-button"),k=p("el-form"),$=p("qrlogin"),P=p("el-col"),B=p("el-row"),z=p("vue2-verify");return y(),v("div",U,[h(n,{color:"#808695",linesColor:"#808695",linesWidth:1,lineLinked:!0,lineOpacity:.4,linesDistance:150,particleOpacity:.7,particlesNumber:60,shapeType:"circle",particleSize:4,moveSpeed:1,hoverEffect:!0,hoverMode:"grab",clickEffect:!0,clickMode:"push",class:"slider-particles"},null,8,["lineOpacity","particleOpacity"]),h(B,{class:"main",type:"flex",justify:"center",gutter:0},{default:S((()=>[h(P,{xs:20,sm:10,md:6,lg:5,class:"login-box"},{default:S((()=>[g("div",_,[g("img",{style:{width:"120px","margin-bottom":"10px"},src:e.$store.state.app.siteInfo.logo},null,8,j),g("h2",null,m(e.$store.state.app.siteInfo.title)+"后台登录",1)]),a.qrloginShow?D("",!0):(y(),x(k,{key:0,ref:"login",model:a.login,rules:a.loginRule,inline:!1,size:"large"},{default:S((()=>[h(d,{label:""},{default:S((()=>[h(u,{type:"text",modelValue:a.baseUrl,"onUpdate:modelValue":t[1]||(t[1]=e=>a.baseUrl=e),"prefix-icon":"el-icon-user",placeholder:"接口"},{prepend:S((()=>[h(r,{style:{width:"80px"},onChange:t[0]||(t[0]=t=>{var i,o,a;return l.bindPickerChange(null==(a=null==(o=null==(i=e.item)?void 0:i.val)?void 0:o.app)?void 0:a.baseUrl)})},{default:S((()=>[(y(!0),v(f,null,w(a.srvList,((e,t)=>{var i,o;return y(),x(s,{key:t,value:e.val.app.siteInfo.title,label:e.val.app.siteInfo.title+""+(null==(o=null==(i=null==e?void 0:e.val)?void 0:i.app)?void 0:o.baseUrl)},null,8,["value","label"])})),128))])),_:1})])),_:1},8,["modelValue"])])),_:1}),h(d,{prop:"account"},{default:S((()=>[h(u,{type:"text",modelValue:a.login.account,"onUpdate:modelValue":t[2]||(t[2]=e=>a.login.account=e),"prefix-icon":"el-icon-user",placeholder:"账号"},null,8,["modelValue"])])),_:1}),h(d,{prop:"password"},{default:S((()=>[h(u,{type:"password",modelValue:a.login.password,"onUpdate:modelValue":t[3]||(t[3]=e=>a.login.password=e),"prefix-icon":"el-icon-lock",placeholder:"密码",onKeyup:t[4]||(t[4]=b((e=>l.handleSubmit("login")),["enter","native"]))},null,8,["modelValue"])])),_:1}),h(d,{prop:"googleAuth"},{default:S((()=>[q(h(u,{type:"text",modelValue:a.login.googleAuth,"onUpdate:modelValue":t[5]||(t[5]=e=>a.login.googleAuth=e),prefix:"ios-person-outline",placeholder:"谷歌验证"},null,8,["modelValue"]),[[V,"googleAuth"==this.admin2step]])])),_:1}),h(d,null,{default:S((()=>[h(c,{class:"full",type:"primary",loading:a.login.loading,onClick:t[6]||(t[6]=e=>l.handleSubmit("login"))},{default:S((()=>[I("登录")])),_:1},8,["loading"])])),_:1})])),_:1},8,["model","rules"])),a.supportQrlogin?(y(),v(f,{key:1},[q(g("div",{class:"qrlogin",onClick:t[7]||(t[7]=e=>{a.qrloginShow=!0})},null,512),[[V,!a.qrloginShow]]),a.activeData.app.apiInfo.qrlogin?q((y(),v("div",L,[g("div",C,[T,g("div",null,[g("span",{onClick:t[8]||(t[8]=e=>{a.qrloginShow=!1}),class:"cursor-pointer"},"账号密码登录")])]),h($,{class:"text-center",qrloginShow:a.qrloginShow,qrurlPrefix:a.activeData.app.apiInfo.qrlogin.qrurlPrefix,apiSeed:a.activeData.app.apiInfo.qrlogin.apiSeed},null,8,["qrloginShow","qrurlPrefix","apiSeed"]),g("div",N,m(a.activeData.app.apiInfo.qrlogin.tip),1)],512)),[[V,a.qrloginShow]]):D("",!0)],64)):D("",!0)])),_:1})])),_:1}),a.useVerify?(y(),x(z,{key:0,onSuccess:l.verifySuccess,mode:"pop",baseUrl:a.activeData.app.apiInfo.domainRoot,captchaType:"blockPuzzle",imgSize:{width:"330px",height:"155px"},ref:"verify"},null,8,["onSuccess","baseUrl"])):D("",!0)])}],["__scopeId","data-v-55e6cf5b"]]);export{P as default};
