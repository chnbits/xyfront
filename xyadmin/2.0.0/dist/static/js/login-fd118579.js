import{_ as e,u as t}from"../index-d1e7aad9.js";const i={props:{apiSeed:{type:String,default:"/v1/qrlogin/qrlogin/getSeed"},qrurlPrefix:{type:String,default:""},qrloginShow:!1},data:()=>({seed:"",qrurl:"",timer:null,timeout:!1}),created:function(){this.loadData()},watch:{qrloginShow(e){e?this.qrurl&&(this.timer=setInterval(this.getLogin,2e3)):clearInterval(this.timer)}},beforeDestroy(){clearInterval(this.timer)},methods:{async loadData(){let e=await this.$xyutil.request({url:this.apiSeed,data:{qrurlPrefix:this.qrurlPrefix},method:"get"});200==e.code?(this.seed=e.data.seed,this.qrurl=e.data.qrurl,this.timeout=!1,clearInterval(this.timer),this.timer=setInterval(this.getLogin,2e3)):this.$xyutil.showToast({title:e.msg,icon:"loading",duration:3e3})},async getLogin(){let e=await this.$xyutil.request({url:"/v1/qrlogin/qrlogin/getLogin?seed="+this.seed,method:"get"});200==e.code&&(e.data.timeout?(this.timeout=!0,clearInterval(this.timer)):(clearInterval(this.timer),this.$store.commit("user/setToken",e.data.token),this.$store.commit("user/setUserInfo",e.data.userInfo),this.$xyutil.showToast({title:e.msg,icon:"success",duration:2e3}),this.$xyutil.switchTab({url:"/"})))}}},a=window.Vue.resolveComponent,o=window.Vue.normalizeStyle,l=window.Vue.openBlock,n=window.Vue.createBlock,s=window.Vue.createCommentVNode,r=window.Vue.createElementBlock,u=window.Vue.createElementVNode;window.Vue.pushScopeId,window.Vue.popScopeId;const d={key:1,class:"xyicon xyicon-history"};var c=e(i,[["render",function(e,t,i,c,p,h){const g=a("xy-qrcode");return l(),r("div",{class:"qr-box",onClick:t[0]||(t[0]=(...e)=>h.loadData&&h.loadData(...e))},[u("div",null,[p.qrurl?(l(),n(g,{key:0,class:"qrcode",style:o({opacity:p.timeout?.3:1}),value:p.qrurl,options:{width:258}},null,8,["style","value"])):s("",!0),p.timeout?(l(),r("span",d)):s("",!0)])])}],["__scopeId","data-v-a2711da8"]]);const p={components:{qrlogin:c},data(){var e,i,a,o;return{supportQrlogin:!1,qrloginShow:!1,activeData:"",srvList:t.getSrvList(),showSrvlist:!1,baseUrl:"",admin2step:"",login:{loading:!1,account:"",password:"",googleAuth:"",mobileVerify:"",emailVerify:"",captchaVerify:""},loginRule:{account:[{required:!0,message:"请填写账号",trigger:"blur"}],password:[{required:!0,message:"请填写密码",trigger:"blur"},{type:"string",min:6,message:"密码至少6位",trigger:"blur"}]},useVerify:null==(o=null==(a=null==(i=null==(e=this.activeData)?void 0:e.app)?void 0:i.apiInfo)?void 0:a.config)?void 0:o.useVerify}},async created(){var e,t,i,a;this.$xyutil.getStorageSync("account")&&(this.login.account=this.$xyutil.getStorageSync("account"),this.login.password=this.$xyutil.getStorageSync("password")),this.baseUrl=this.$xyutil.getStorageSync("xyadmin-active"),this.$route.query.mul?(this.showSrvlist=!0,this.baseUrl||(this.baseUrl=window.location.protocol+"//"+window.location.host+window.location.pathname+"api")):this.baseUrl=window.location.protocol+"//"+window.location.host+window.location.pathname+"api",await this.getSiteInfo(),this.useVerify=null==(a=null==(i=null==(t=null==(e=this.activeData)?void 0:e.app)?void 0:t.apiInfo)?void 0:i.config)?void 0:a.useVerify,this.activeData.app.apiInfo.qrlogin&&(this.supportQrlogin=!0,this.activeData.app.apiInfo.qrlogin.isDefault&&(this.qrloginShow=!0))},methods:{bindPickerChange:function(e){e&&(this.baseUrl=e)},verifySuccess(e){this.login.captchaVerify=e,this.loginSubmit()},useVerifyShow(){this.$refs.verify&&this.$refs.verify.show()},async handleSubmit(){await this.getSiteInfo(),this.activeData.app.apiInfo.config&&this.activeData.app.apiInfo.config.useVerify?this.useVerifyShow():this.loginSubmit()},async getSiteInfo(){if(this.baseUrl)if(this.$xyutil.setStorageSync("xyadmin-active",this.baseUrl),this.activeData=this.$xyutil.getStorageSync("xyadmin-vuex-"+this.baseUrl),this.activeData||(this.activeData=this.$xyutil.getStorageSync("xyadmin-vuex-default")),this.activeData){this.activeData=JSON.parse(this.activeData);let e=await this.$xyutil.request({url:this.baseUrl,method:"get"});if(200!=e.code)return this.$xyutil.showToast({title:"接口异常，请检查服务器接口！",icon:"loading",duration:2e3}),!1;e.data.api.urlLogin&&(window.location.href=e.data.api.urlLogin),this.activeData.app.apiInfo=e.data,e.data.siteInfo&&(e.data.siteInfo.admin2step&&(this.admin2step=e.data.siteInfo.admin2step.login[0]),this.activeData.app.baseUrl=this.baseUrl,this.activeData.app.siteInfo=e.data.siteInfo)}else alert("不存在xyadmin-vuex-default")},loginSubmit:async function(){this.login.loading=!0;let e=this;setTimeout((function(){e.login.loading=!1}),5e3);let t=await this.$xyutil.request({url:this.activeData.app.apiInfo.api.apiBase+this.activeData.app.apiInfo.api.apiLogin,data:this.login,method:"post"});200==t.code?(this.activeData.user.token=t.data.token,this.activeData.user.userInfo=t.data.userInfo,this.activeData.menu.menuList="",this.$xyutil.showToast({title:t.msg,icon:"success",duration:1e3}),this.$xyutil.setStorageSync("xyadmin-vuex-"+this.baseUrl,JSON.stringify(this.activeData)),this.$xyutil.reLaunch()):this.$xyutil.showToast({title:t.msg,icon:"loading",duration:3e3}),this.login.loading=!1}}},h=window.Vue.resolveComponent,g=window.Vue.createVNode,w=window.Vue.createElementVNode,f=window.Vue.toDisplayString,m=window.Vue.renderList,v=window.Vue.Fragment,y=window.Vue.openBlock,S=window.Vue.createElementBlock,x=window.Vue.createBlock,V=window.Vue.withCtx,q=window.Vue.withKeys,b=window.Vue.vShow,I=window.Vue.withDirectives,D=window.Vue.createTextVNode,k=window.Vue.createCommentVNode,$=window.Vue.pushScopeId,U=window.Vue.popScopeId,_=e=>($("data-v-4a2892d2"),e=e(),U(),e),L={class:"wrap"},C={style:{width:"100%",color:"#fff","margin-bottom":"30px"}},T=["src"],N=D("登录"),P={key:0,class:"qrlogin-modal"},B={class:"flex space-between m-b"},z=_((()=>w("div",null,null,-1))),E={class:"text-center m-t"};var O=e(p,[["render",function(e,t,i,a,o,l){const n=h("vue-particles"),s=h("el-option"),r=h("el-select"),u=h("el-input"),d=h("el-form-item"),c=h("el-button"),p=h("el-form"),D=h("qrlogin"),$=h("el-col"),U=h("el-row"),_=h("vue2-verify");return y(),S("div",L,[g(n,{color:"#808695",linesColor:"#808695",linesWidth:1,lineLinked:!0,lineOpacity:.4,linesDistance:150,particleOpacity:.7,particlesNumber:60,shapeType:"circle",particleSize:4,moveSpeed:1,hoverEffect:!0,hoverMode:"grab",clickEffect:!0,clickMode:"push",class:"slider-particles"},null,8,["lineOpacity","particleOpacity"]),g(U,{class:"main",type:"flex",justify:"center",gutter:0},{default:V((()=>[g($,{xs:20,sm:10,md:6,lg:5,class:"login-box"},{default:V((()=>[w("div",C,[w("img",{style:{width:"120px","margin-bottom":"10px"},src:e.$store.state.app.siteInfo.logo},null,8,T),w("h2",null,f(e.$store.state.app.siteInfo.title)+"后台登录",1)]),o.qrloginShow?k("",!0):(y(),x(p,{key:0,ref:"login",model:o.login,rules:o.loginRule,inline:!1,size:"large"},{default:V((()=>[g(d,{label:""},{default:V((()=>[g(u,{type:"text",modelValue:o.baseUrl,"onUpdate:modelValue":t[1]||(t[1]=e=>o.baseUrl=e),"prefix-icon":"el-icon-user",placeholder:"接口"},{prepend:V((()=>[g(r,{style:{width:"80px"},onChange:t[0]||(t[0]=t=>{var i,a,o;return l.bindPickerChange(null==(o=null==(a=null==(i=e.item)?void 0:i.val)?void 0:a.app)?void 0:o.baseUrl)})},{default:V((()=>[(y(!0),S(v,null,m(o.srvList,((e,t)=>{var i,a;return y(),x(s,{key:t,value:e.val.app.siteInfo.title,label:e.val.app.siteInfo.title+""+(null==(a=null==(i=null==e?void 0:e.val)?void 0:i.app)?void 0:a.baseUrl)},null,8,["value","label"])})),128))])),_:1})])),_:1},8,["modelValue"])])),_:1}),g(d,{prop:"account"},{default:V((()=>[g(u,{type:"text",modelValue:o.login.account,"onUpdate:modelValue":t[2]||(t[2]=e=>o.login.account=e),"prefix-icon":"el-icon-user",placeholder:"账号"},null,8,["modelValue"])])),_:1}),g(d,{prop:"password"},{default:V((()=>[g(u,{type:"password",modelValue:o.login.password,"onUpdate:modelValue":t[3]||(t[3]=e=>o.login.password=e),"prefix-icon":"el-icon-lock",placeholder:"密码",onKeyup:t[4]||(t[4]=q((e=>l.handleSubmit("login")),["enter","native"]))},null,8,["modelValue"])])),_:1}),g(d,{prop:"googleAuth"},{default:V((()=>[I(g(u,{type:"text",modelValue:o.login.googleAuth,"onUpdate:modelValue":t[5]||(t[5]=e=>o.login.googleAuth=e),prefix:"ios-person-outline",placeholder:"谷歌验证"},null,8,["modelValue"]),[[b,"googleAuth"==this.admin2step]])])),_:1}),g(d,null,{default:V((()=>[g(c,{class:"full",type:"primary",loading:o.login.loading,onClick:t[6]||(t[6]=e=>l.handleSubmit("login"))},{default:V((()=>[N])),_:1},8,["loading"])])),_:1})])),_:1},8,["model","rules"])),o.supportQrlogin?(y(),S(v,{key:1},[I(w("div",{class:"qrlogin",onClick:t[7]||(t[7]=e=>{o.qrloginShow=!0})},null,512),[[b,!o.qrloginShow]]),o.activeData.app.apiInfo.qrlogin?I((y(),S("div",P,[w("div",B,[z,w("div",null,[w("span",{onClick:t[8]||(t[8]=e=>{o.qrloginShow=!1}),class:"cursor-pointer"},"账号密码登录")])]),g(D,{class:"text-center",qrloginShow:o.qrloginShow,qrurlPrefix:o.activeData.app.apiInfo.qrlogin.qrurlPrefix,apiSeed:o.activeData.app.apiInfo.qrlogin.apiSeed},null,8,["qrloginShow","qrurlPrefix","apiSeed"]),w("div",E,f(o.activeData.app.apiInfo.qrlogin.tip),1)],512)),[[b,o.qrloginShow]]):k("",!0)],64)):k("",!0)])),_:1})])),_:1}),o.useVerify?(y(),x(_,{key:0,onSuccess:l.verifySuccess,mode:"pop",baseUrl:o.activeData.app.apiInfo.domainRoot,captchaType:"blockPuzzle",imgSize:{width:"330px",height:"155px"},ref:"verify"},null,8,["onSuccess","baseUrl"])):k("",!0)])}],["__scopeId","data-v-4a2892d2"]]);export{O as default};
